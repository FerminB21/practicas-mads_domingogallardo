



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Práctica 3 - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#practica-3-trabajo-en-equipo-con-gitflow-y-despliegue-de-la-aplicacion" tabindex="0" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Prácticas MADS" aria-label="Prácticas MADS" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Prácticas MADS
            </span>
            <span class="md-header-nav__topic">
              
                Práctica 3
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo">
      
        <img alt="logo" src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Práctica 1
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Práctica 1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/intro-spring-boot.html" title="Introducción a Spring Boot para MADS" class="md-nav__link">
      Introducción a Spring Boot para MADS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/comandos-git.html" title="Comandos Git" class="md-nav__link">
      Comandos Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica0.html" title="Primera aplicación con Spring Boot" class="md-nav__link">
      Primera aplicación con Spring Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica1.html" title="Aplicación ToDoList" class="md-nav__link">
      Aplicación ToDoList
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-pruebas-tdd/integration-tdd.html" title="Práctica 2" class="md-nav__link">
      Práctica 2
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Práctica 3
      </label>
    
    <a href="gitflow-despliegue.html" title="Práctica 3" class="md-nav__link md-nav__link--active">
      Práctica 3
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objetivos-y-resumen-de-la-practica" class="md-nav__link">
    Objetivos y resumen de la práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formacion-de-equipos" class="md-nav__link">
    Formación de equipos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#roles-en-el-equipo" class="md-nav__link">
    Roles en el equipo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuevo-flujo-de-trabajo-para-los-issues" class="md-nav__link">
    Nuevo flujo de trabajo para los issues
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comandos-git" class="md-nav__link">
    Comandos Git
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-gitflow" class="md-nav__link">
    Configuración de GitFlow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ramas-de-largo-recorrido" class="md-nav__link">
    Ramas de largo recorrido
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ramas-de-feature" class="md-nav__link">
    Ramas de feature
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ramas-de-release" class="md-nav__link">
    Ramas de release
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#despliegue-en-produccion-con-docker" class="md-nav__link">
    Despliegue en producción con Docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sobreescribir-propiedades-desde-la-linea-de-comando" class="md-nav__link">
    Sobreescribir propiedades desde la línea de comando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagen-docker-de-la-aplicacion" class="md-nav__link">
    Imagen Docker de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_4" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-y-evaluacion" class="md-nav__link">
    Entrega y evaluación
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04-iteracion-scrum/iteracion-scrum.html" title="Práctica 4" class="md-nav__link">
      Práctica 4
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objetivos-y-resumen-de-la-practica" class="md-nav__link">
    Objetivos y resumen de la práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formacion-de-equipos" class="md-nav__link">
    Formación de equipos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#roles-en-el-equipo" class="md-nav__link">
    Roles en el equipo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuevo-flujo-de-trabajo-para-los-issues" class="md-nav__link">
    Nuevo flujo de trabajo para los issues
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comandos-git" class="md-nav__link">
    Comandos Git
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-gitflow" class="md-nav__link">
    Configuración de GitFlow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ramas-de-largo-recorrido" class="md-nav__link">
    Ramas de largo recorrido
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ramas-de-feature" class="md-nav__link">
    Ramas de feature
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ramas-de-release" class="md-nav__link">
    Ramas de release
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#despliegue-en-produccion-con-docker" class="md-nav__link">
    Despliegue en producción con Docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sobreescribir-propiedades-desde-la-linea-de-comando" class="md-nav__link">
    Sobreescribir propiedades desde la línea de comando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagen-docker-de-la-aplicacion" class="md-nav__link">
    Imagen Docker de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_4" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-y-evaluacion" class="md-nav__link">
    Entrega y evaluación
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="practica-3-trabajo-en-equipo-con-gitflow-y-despliegue-de-la-aplicacion">Práctica 3: Trabajo en equipo con GitFlow y despliegue de la aplicación<a class="headerlink" href="#practica-3-trabajo-en-equipo-con-gitflow-y-despliegue-de-la-aplicacion" title="Permanent link">&para;</a></h1>
<h2 id="objetivos-y-resumen-de-la-practica">Objetivos y resumen de la práctica<a class="headerlink" href="#objetivos-y-resumen-de-la-practica" title="Permanent link">&para;</a></h2>
<p>En esta práctica se pretende conseguir:</p>
<ol>
<li>Crear los equipos de trabajo en GitHub.</li>
<li>Adaptar el flujo de trabajo en Git y GitHub al trabajo en equipo.<ul>
<li>Implementar GitFlow.</li>
<li>Desarrollar nuevas features con GitFlow.</li>
<li>Lanzamiento de una versión nueva usando GitFlow.</li>
</ul>
</li>
<li>Despliegue en producción de la aplicación, construyendo una imagen
   docker y lanzándola junto con la base de datos con <code>docker
   compose</code>.</li>
</ol>
<h2 id="formacion-de-equipos">Formación de equipos<a class="headerlink" href="#formacion-de-equipos" title="Permanent link">&para;</a></h2>
<p>En esta práctica comenzamos a trabajar en equipos de 3 personas (de
forma excepcional podrían ser 2 o 4 personas).</p>
<p>Cada equipo trabajará con un repositorio común seleccionado de uno de
los miembros del equipo. Se formará también un <em>team</em> en la
organización <code>mads-ua</code> en el que participarán todos los miembros
del equipo.</p>
<p><img src="imagenes/equipos-mads-ua.png" width="700px"/></p>
<p>Utilizaremos <em>GitHub Classroom</em> para crear el <em>team</em> y el repositorio.</p>
<h3 id="roles-en-el-equipo">Roles en el equipo<a class="headerlink" href="#roles-en-el-equipo" title="Permanent link">&para;</a></h3>
<p>Cada una de las tres personas del equipo tendrá un papel
diferente. </p>
<ul>
<li><strong>Responsable de GitHub</strong>: encargado de gestionar el flujo de Git y
  de supervisar los pull requests, issues y tablero de GitHub.</li>
<li><strong>Resposable de integración continua (devop)</strong>: encargado
  de gestionar Travis, Docker y configuraciones del proyecto.</li>
<li><strong>Responsable del producto</strong>: encargado de conocer y gestionar las
  historias de usuario, el tablero Trello y las pruebas de usuario del
  producto. </li>
</ul>
<p>Debéis elegir quién va a tener cada papel.</p>
<h3 id="pasos-a-seguir">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Debéis formar equipos de <strong>3 personas</strong>. Enviad los componentes al
  foro de Moodle y os asignaré un nombre de equipo. Utilizad después
  el enlace de GitHub Classroom que enviaré al foro de Moodle para
  crear el equipo y apuntaros a él.</p>
<p>El primero que use el enlace debe crear el repositorio,
escribiendo el nombre del equipo, como se muestra en la siguiente
imagen.</p>
<p><img src="imagenes/nombre-repo-github-classroom.png" width="600px"/></p>
<p>El equipo trabajará con un repositorio creado por GitHub Classroom
con el nombre <code>todolistgrupo-2019-NOMBRE-EQUIPO</code>. Al igual que en
la práctica 1, el repositorio se creará en el grupo <code>mads-ua</code>.</p>
<p><img src="imagenes/repo-creado-github-classroom.png" width="700px"/></p>
<p>Una vez que la primera persona ha creado el equipo y el
repositorio, las siguientes personas que usan el enlace pueden
unirse al equipo creado o crear un nuevo equipo:</p>
<p><img src="imagenes/unirse-repo-github-classroom.png" width="700px"/></p>
</li>
<li>
<p>Una vez creado el repositorio debéis crear en él un tablero para
  gestionar las tarjetas con los <em>issues</em> y los pull
  requests. Creadlos con las mismas columnas que en las prácticas 1 y 2.</p>
</li>
<li>
<p>Escoged el proyecto que vais a usar como punto de partida de estas
  dos últimas prácticas de entre los proyectos de los miembros del
  equipo. Intentad que se un proyecto con código limpio y fácilmente
  ampliable.</p>
<p>Subidlo al nuevo repositorio, cambiando la URL del <code>origin</code> del
repositorio local y haciendo un push:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git remote set-url origin https://github.com/mads-ua/todolistgrupo-2019-NOMBRE-EQUIPO.git
$ git push -u origin master
</code></pre></div>
</td></tr></table>

<p>Por último, los otros miembros del equipo deberán clonar el
repositorio para que los tres podáis trabajar con él en local.</p>
</li>
<li>
<p>Cambiad el nombre del proyecto (en el fichero <code>POM.xml</code> y en el
  <code>about.html</code> a <code>mads-todolist-equipo-XX</code>.</p>
<p>Haced un commit directamente en <code>master</code> con estos cambios.</p>
<p>Para conectar el repositorio con Travis el responsable de
integración continua debe acceder a su cuenta personal en
Travis.com y sincronizar el nuevo repositorio <code>todolistgrupo</code> en
la organización <code>mads-ua</code>. Puedes acceder a la página para
sincronizar este nuevo repositorio desde la página principal de
Travis, pulsando el botón <code>+</code>:</p>
<p><img src="imagenes/builds-travis-add.png" width="600px"/></p>
</li>
</ul>
<h2 id="nuevo-flujo-de-trabajo-para-los-issues">Nuevo flujo de trabajo para los <em>issues</em><a class="headerlink" href="#nuevo-flujo-de-trabajo-para-los-issues" title="Permanent link">&para;</a></h2>
<p>Debemos adaptar el flujo de trabajo en GitHub al trabajo en equipo. En
cuanto a la gestión de los <em>issues</em> y tablero del proyecto cambiaremos
lo siguiente:</p>
<ul>
<li><strong>Selección del <em>issue</em></strong>: Al pasar un <em>issue</em> de <code>To do</code>a <code>In
  progress</code> se debe asignar un responsable del desarrollo del <em>issue</em>.</li>
<li><strong>Nueva rama con el <em>issue</em></strong>: El responsable seleccionado será el que abra una
  rama nueva para el desarrollo del ticket y la subirá a
  GitHub.</li>
<li><strong>Desarrollo</strong>: Se trabaja en la rama. Cualquier compañero puede
  unirse al ticket y trabajar junto con el responsable, trabajando
  sobre la rama.</li>
<li><strong>Pull request</strong>: Cuando el ticket se ha terminado, el responsable
  abre un pull request en GitHub y pone la tarjeta en la columna
  <code>In pull request</code>. Se archiva la tarjeta del <em>issue</em>.</li>
<li><strong>Revisión de código</strong>: Los miembros del equipo revisan el código en
  el pull request (consultar documentación en GitHub: <a href="https://help.github.com/articles/reviewing-proposed-changes-in-a-pull-request/">Reviewing
  proposed changes in a pull
  request</a>). Al
  menos uno de los miembros del equipo deben dar el OK, añadiendo una
  reacción.</li>
<li><strong>Integración del pull request</strong>: Cuando un miembro da el OK, el
  responsable de la tarea integra el pull request.</li>
</ul>
<p>Para implementar el trabajo en equipo será necesario trabajar sobre
ramas remotas compartidas. A continuación explicamos con más detalle
algunos aspectos comandos de Git necesarios.</p>
<h3 id="comandos-git">Comandos Git<a class="headerlink" href="#comandos-git" title="Permanent link">&para;</a></h3>
<p>Veamos algunos comandos de Git relacionados con el trabajo compartido
en repositorios y ramas remotas.</p>
<ul>
<li>
<p>Subir una rama al repositorio remoto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git checkout -b nueva-rama
$ git push -u origin nueva-rama
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Descargar una rama del repositorio remoto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git fetch 
$ git checkout nueva-rama
</code></pre></div>
</td></tr></table>

<p>El comando <code>git fetch</code> se descarga todos los cambios pero no los
mezcla con las ramas locales. Los deja en ramas <em>remote tracking</em> a las
que les da el nombre del servidor y la rama
(<code>origin/nueva-rama</code>). </p>
<p>En el caso del comando anterior, el comando <code>git checkout
nueva-rama</code> es equivalente a <code>git checkout -b nueva-rama
origin/nueva-rama</code>. Se crea una rama local <code>nueva-rama</code> conectada
a la rama <code>origin/nueva-rama</code>.</p>
</li>
<li>
<p>Actualizar una rama con cambios que otros compañeros han subido al
  repositorio remoto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git pull
</code></pre></div>
</td></tr></table>

<p>El comando <code>git pull</code> es equivalente a un <code>git fetch</code> seguido de
un <code>git merge</code>. El comando <code>git fetch</code> actualiza la rama remota
<code>origin/nueva-rama</code>. El comando <code>git pull</code> es equivalente a hacer:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git checkout nueva-rama
$ git fetch
$ git merge origin/nueva-rama
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Subir cambios de la rama actual:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">(estando en la rama que queremos subir)</span>
<span class="err">$ git push</span>
</code></pre></div>
</td></tr></table>

<p>El comando <code>git push</code> funcionará correctamente sin más parámetros
si previamente hemos subido la rama con un <code>git push -u</code>.</p>
</li>
<li>
<p>Comprobar el estado de las ramas locales y remotas:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git branch -vv
</code></pre></div>
</td></tr></table>

<p>Este comando no accede directamente al servidor, sino que muestra
la información de la última vez que se accedió a él. Si queremos
la información actualizada podemos hacer un <code>git fetch --all</code>
antes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git fetch --all
$ git branch -vv
</code></pre></div>
</td></tr></table>

<p>Es importante recordar que <code>git fetch</code> (a diferencia de <code>git
pull</code>) no modifica los repositorios locales, sino que baja las
ramas remotas cachés locales.</p>
</li>
<li>
<p>Información de los repositorios remotos:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git remote show origin
</code></pre></div>
</td></tr></table>

<p>Proporciona información del repositorio remoto, todas sus ramas,
del local y de la conexión entre ambos.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git remote -v update
</code></pre></div>
</td></tr></table>

<p>Proporciona información del estado de las ramas remotas y locales
(si están actualizadas o hay cambios en algunas no bajadas o
subidas).</p>
</li>
<li>
<p>Borrado de ramas remotas desde el terminar:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git push origin --delete nueva-rama
$ git remote prune origin
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Si necesitamos en la rama de <em>feature</em> código que se haya añadido en
  la rama <code>master</code>.</p>
<p>Podemos hacer un <em>merge</em> de la rama <code>master</code> en la rama de
<em>feature</em> para incorporar los avances de código que se han hecho
en <code>master</code> y que necesitamos en nuestra nueva rama:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git checkout nueva-rama
$ git merge master
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Solución de conflictos en un <em>pull request</em>:</p>
<p>Recordamos lo que hemos visto en teoría sobre la solución de
conflictos detectados en un <em>pull request</em>.</p>
<p>Supongamos que hay un conflicto entre la nueva rama y
<code>master</code>. GitHub detectará el conflicto en la página de <em>pull
request</em>. Para arreglar el conflicto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git checkout master
$ git pull
$ git checkout nueva-rama
$ git merge master
<span class="c1"># arreglar el conflicto</span>
$ git push
<span class="c1"># ya se puede hacer el merge en GitHub</span>
</code></pre></div>
</td></tr></table>

</li>
</ul>
<h3 id="pasos-a-seguir_1">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_1" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Probad el nuevo flujo de trabajo en el tablero del proyecto creando
  un nuevo <em>issue</em> denominado <code>Actualizar la página Acerca de</code>. En la
  descripción de <em>issue</em> comentad que se debe modificar la página para
  que muestren todos los miembros del equipo y el nuevo número de
  versión de la aplicación (<code>1.3.0-SNAPSHOT</code>).</p>
</li>
<li>
<p>Escoged una persona del equipo como responsable del <em>issue</em>. El
  responsable del <em>issue</em> será el responsable de integrarlo en
  <code>master</code> y de solucionar los conflictos que puedan surgir.</p>
</li>
<li>
<p>Probad los comandos Git anteriores en una rama en la que se resuelva
  el <em>issue</em>. Cada miembro del equipo deberá realizar un commit en el
  que se añada su nombre a la lista de autores de la aplicación,
  indicando también su papel en el equipo.</p>
</li>
<li>
<p>Cread el pull request en GitHub, poniendo como responsable del PR al
  mismo responsable del <em>issue</em>.</p>
</li>
<li>
<p>Provocad un conflicto y arregladlo. Para ello se debe añadir un
  commit en <code>master</code> que entre en conflicto con los cambios realizados
  en la rama. Después se arreglará el conflicto y se subirá la
  solución al pull request.</p>
</li>
<li>
<p>Por último, revisad el código, aceptadlo e integrad el PR en <em>master</em>.</p>
</li>
</ul>
<h2 id="configuracion-de-gitflow">Configuración de GitFlow<a class="headerlink" href="#configuracion-de-gitflow" title="Permanent link">&para;</a></h2>
<p>El flujo de trabajo Git que vamos a seguir es muy similar al flujo de
trabajo GitFlow (recordad la <a href="https://github.com/domingogallardo/apuntes-mads/blob/master/sesiones/07-git-workflows/git-workflows.md">clase de
teoría</a>). </p>
<h3 id="ramas-de-largo-recorrido">Ramas de largo recorrido<a class="headerlink" href="#ramas-de-largo-recorrido" title="Permanent link">&para;</a></h3>
<p>En GitFlow se publican las distintas versiones del proyecto en la rama
<em>long-lived</em> <code>master</code> y se hace el desarrollo en la rama
<code>develop</code>. A partir de ahora no desarrollaremos directamente en
<code>master</code> sino en <code>develop</code>.</p>
<p>En la página de configuración del repositorio en GitHub en <code>Settings &gt;
Branches &gt; Default branch</code> se puede configurar la rama por defecto
contra la que se realizarán los commits y la que aparecerá en la
página del proyecto. Tendréis que definir <code>develop</code>.</p>
<h3 id="ramas-de-feature">Ramas de feature<a class="headerlink" href="#ramas-de-feature" title="Permanent link">&para;</a></h3>
<p>Desde el comienzo de trabajo con Git en las prácticas 1 y 2 estamos
haciendo un desarrollo basado en ramas de corto recorrido,
equivalentes a las ramas de <em>features</em> de GitFlow. </p>
<p>Tal y como se comenta en GitFLow estas ramas saldrán de <code>develop</code> y se
integrarán en <code>develop</code>. La diferencia es que en GitFlow estas ramas
se integran con la rama de desarrollo manualmente haciendo <code>merge</code>,
mientras que nosotros las integramos haciendo un pull request.</p>
<h3 id="ramas-de-release">Ramas de release<a class="headerlink" href="#ramas-de-release" title="Permanent link">&para;</a></h3>
<p>Hasta ahora hemos hecho los <em>releases</em> en la rama <code>master</code>. A partir
de ahora seguiremos la estrategia de GitFlow y haremos ramas de
<em>release</em> que salen de <code>develop</code> y se integran en <code>master</code> y en
<code>develop</code>.</p>
<p>Haremos también la integración haciendo pull request.</p>
<h3 id="pasos-a-seguir_2">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_2" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>El <strong>responsable de GitHub</strong> se debe encargar de
crear la rama <strong><code>develop</code></strong> y configurarla como rama principal del
proyecto en GitHub. Todos los otros miembros deberán descargarla y
moverse a ella en sus repositorios locales. Esta rama pasará a ser la
de desarrollo principal. </p>
</li>
<li>
<p>El <strong>responsable de integración continua</strong> modificará el fichero de
configuración de Travis, para que también se lancen los builds en la
rama <code>develop</code> (además de en la rama <code>master</code>).</p>
</li>
<li>
<p>Haced un PR de prueba en la rama <code>develop</code> para comprobar que todo
  funciona bien.</p>
</li>
<li>
<p>Cread tres <em>issues</em> distintos, simulando tres nuevas
  funcionalidades. Deben ser issues muy sencillos (cambiar el color de
  algún elemento de la aplicación, cambiar un texto, o algo
  similar). Cada uno de los miembros del equipo será el responsable de
  uno de los issues. </p>
</li>
<li>
<p>El <strong>responsable de GitHub</strong> configurará el repositorio para obligar
  a que cualquier <em>pull request</em> tenga que tener la revisión de una
  persona distinta del responsable del PR.</p>
</li>
</ul>
<p>Desarrollar e integrar los issues en <code>develop</code> siguiendo el flujo de
  trabajo planteado anteriormente. El <strong>responsable de GitHub</strong> se
  asegurará de que el tablero de GitHub se actualiza correctamente.</p>
<ul>
<li>
<p>Por último, vamos a probar el lanzamiento de una release usando el flujo de
  trabajo. Cread un <em>issue</em> con la tarea <em>Lanzar release 1.3.0</em> que
  tendrá como responsable al responsable de GitHub.</p>
</li>
<li>
<p>El <strong>responsable de GitHub</strong> deberá <strong>publicar la nueva versión</strong> siguiendo
  los pasos de GitFlow:</p>
<ul>
<li>Crear la rama local <code>release-1.3.0</code> a partir de <code>develop</code>.</li>
<li>Realizar en esta rama los cambios específicos de la versión. En
  nuestro caso:<ul>
<li>Cambiar en la página <code>Acerca de</code> "Versión 1.3.0-SNAPSHOT" a
  "Versión 1.3.0" y añadir la fecha de publicación.</li>
<li>Cambiar el fichero <code>pom.xml</code>.</li>
</ul>
</li>
<li>Publicar la rama <code>release-1.3.0</code> en GitHub y hacer un pull
  request sobre <code>master</code>. Una vez mezclado el PR añadir la
  etiqueta con la nueva versión <code>1.3.0</code> en <code>master</code> creando la
  página de release en GitHub.</li>
<li>Mezclar también la rama de release con <code>develop</code> (se puede hacer
  también con un PR).</li>
</ul>
</li>
<li>
<p>Una vez hecho esto ya se puede borrar la rama <code>release-1.3.0</code> y las
  ramas <code>master</code> y <code>develop</code> estarán actualizadas a la nueva
  versión. Hacer por último un commit en <code>develop</code> (no hace falta PR)
  cambiando la versión a <code>1.4.0-SNAPSHOT</code>.</p>
</li>
<li>
<p>La rama <code>develop</code> también será integrada por Travis. Debemos
  comprobar que pasan todos los tests de las nuevas características
  que se añaden.</p>
</li>
<li>
<p>Por último, deberéis <strong>realizar un <em>hot fix</em></strong>, simulando la resolución
  de un error, siguiendo el flujo de trabajo de GitFlow, y
  actualizando el número de versión a <code>1.3.1</code>.</p>
</li>
</ul>
<h2 id="despliegue-en-produccion-con-docker">Despliegue en producción con Docker<a class="headerlink" href="#despliegue-en-produccion-con-docker" title="Permanent link">&para;</a></h2>
<p>Este apartado lo realizará el <strong>responsable de integración continua</strong>,
pero todos los miembros del equipo deben conocer y entender todos los
pasos.</p>
<h3 id="sobreescribir-propiedades-desde-la-linea-de-comando">Sobreescribir propiedades desde la línea de comando<a class="headerlink" href="#sobreescribir-propiedades-desde-la-linea-de-comando" title="Permanent link">&para;</a></h3>
<p>Hemos visto que al lanzar la aplicación Spring Boot podemos
seleccionar el perfil activo. Por ejemplo para lanzar la aplicación
usando como perfil activo el fichero <code>application-mysql.properties</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">mvn spring-boot:run -Dspring.profiles.active=mysql</span>
</code></pre></div>
</td></tr></table>

<p>También hemos visto que podemos seleccionar este perfile para lanzar los tests:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">mvn test -Dspring.profiles.active=mysql</span>
</code></pre></div>
</td></tr></table>

<p>La opción <code>-D</code> permite sobreescribir una propiedad del fichero de
propiedades. Por ejemplo, podemos lanzar la aplicación modificando el
usuario y la contraseña de una conexión a una base de datos con el
siguiente comando:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">mvn spring-boot:run -Dspring.datasource.username=root -Dspring.datasource.password=12345678</span>
</code></pre></div>
</td></tr></table>

<p>También es posible definir variables en el propio fichero de
propiedades para proporcionar nombres más cortos o reutilizar un mismo
valor en varias propiedades.</p>
<p>Por ejemplo, en el siguiente fichero <code>application.properties</code>
definimos el <a href="https://stackoverflow.com/a/37167120/540801">nivel de
logging</a> (que puede ser
<code>off</code>, <code>fatal</code>, <code>error</code>, <code>warn</code>, <code>info</code>, <code>debug</code>, <code>trace</code>, <code>all</code>) y
usamos el mismo nivel para los distintos paquetes de la aplicación:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>logging=info
logging.level.org.springframework=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
logging.level.root=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
logging.level.org.hibernate=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
logging.level.sql=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
</code></pre></div>
</td></tr></table>

<p>Podríamos entonces modificar el nivel de logs modificando la variable
<code>logging</code> al lanzar los tests de la aplicación, para que sólo muestre
los mensajes de error:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">mvn test -Dloggin=error</span>
</code></pre></div>
</td></tr></table>

<p>En la aplicación vamos a usar esta variable y también otras que nos
van a permitir configurar las propiedades relacionadas con la conexión
con la base de datos.</p>
<h3 id="pasos-a-seguir_3">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_3" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Abre un <em>issue</em> denominado <code>Dockerización de la aplicación</code> en el
  que vas a configurar la aplicación para lanzarla con
  <code>docker-compose</code>. Como siempre, desarrolla el <em>issue</em> en una rama
  propia.</p>
</li>
<li>
<p>Modifica los ficheros de propiedades de ejecución para que queden de
  la siguiente forma:</p>
<p><strong>Fichero <code>src/main/resources/application.properties</code></strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>spring.datasource.url=jdbc:h2:mem:dev
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.ddl-auto=update
spring.datasource.data=classpath:datos-dev.sql
spring.datasource.initialization-mode=always
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console

logging=info
logging.level.org.springframework=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
logging.level.root=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
logging.level.org.hibernate=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
logging.level.sql=<span class="cp">${</span><span class="n">logging</span><span class="cp">}</span>
</code></pre></div>
</td></tr></table>

<p><strong>Fichero <code>src/main/resources/application-mysql.properties</code></strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>db_ip=localhost:3306
db_user=root
db_passwd=
spring.datasource.url=jdbc:mysql://<span class="cp">${</span><span class="n">db_ip</span><span class="cp">}</span>/mads
spring.datasource.username=<span class="cp">${</span><span class="n">db_user</span><span class="cp">}</span>
spring.datasource.password=<span class="cp">${</span><span class="n">db_passwd</span><span class="cp">}</span>
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5InnoDBDialect
spring.jpa.hibernate.ddl-auto=update
spring.datasource.initialization-mode=never
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Probamos que funcionan bien las variables de
  configuración. Para ello, lanzamos mysql en un puerto distinto, el 3316:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker run -d -p 3316:3306 --name mysql-otro-puerto -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_DATABASE=mads mysql:5</span>
</code></pre></div>
</td></tr></table>

<p>y probamos a lanzar la aplicación modificando la variable <code>db_ip</code>
para que se conecte a ese nuevo puerto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">mvn spring-boot:run -Dspring.profiles.active=mysql -Ddb_ip=localhost:3316</span>
</code></pre></div>
</td></tr></table>

<p>La aplicación debe arrancar correctamente, conectándose a la base
de datos en el nuevo puerto.</p>
<p>Por último, borramos el contenendor de prueba creado:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err"> docker container stop mysql-otro-puerto</span>
<span class="err"> docker container rm mysql-otro-puerto</span>
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Realiza un commit con los nuevos ficheros de propiedades.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Es posible utilizar la variable <code>db_ip</code> para facilitar la conexión
de la aplicación a un contenedor Docker de MySQL lanzado en
Windows con <em>Docker Toolbox</em>. En este caso hay que especificar la
dirección IP en la que se está ejecutando el contenedor Docker.</p>
</div>
<h3 id="imagen-docker-de-la-aplicacion">Imagen Docker de la aplicación<a class="headerlink" href="#imagen-docker-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>Hemos visto <a href="https://github.com/domingogallardo/apuntes-mads/blob/master/sesiones/08-integracion-entrega-continua/integracion-entrega-continua.md#demostración-de-docker">en teoría</a> cómo crear imágenes Docker. Vamos a crear una
imagen con nuestra aplicación <code>mads-todolist</code>.</p>
<p>El fichero <code>Dockerfile</code> es el responsable de construir la máquina
Docker. Usaremos el siguiente <code>Dockerfile</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">####</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">application</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="nl">openjdk</span><span class="p">:</span><span class="mi">8</span><span class="o">-</span><span class="n">jdk</span><span class="o">-</span><span class="n">alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">build</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nc">image</span><span class="w"></span>
<span class="n">WORKDIR</span><span class="w"> </span><span class="o">/</span><span class="n">app</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Copy</span><span class="w"> </span><span class="n">maven</span><span class="w"> </span><span class="n">executable</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nc">image</span><span class="w"></span>
<span class="n">COPY</span><span class="w"> </span><span class="n">mvnw</span><span class="w"> </span><span class="p">.</span><span class="w"></span>
<span class="n">COPY</span><span class="w"> </span><span class="p">.</span><span class="n">mvn</span><span class="w"> </span><span class="p">.</span><span class="n">mvn</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Copy</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pom</span><span class="p">.</span><span class="nc">xml</span><span class="w"> </span><span class="k">file</span><span class="w"></span>
<span class="n">COPY</span><span class="w"> </span><span class="n">pom</span><span class="p">.</span><span class="nc">xml</span><span class="w"> </span><span class="p">.</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">preparation</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">offline</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">separate</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="n">unless</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pom</span><span class="p">.</span><span class="nc">xml</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">changed</span><span class="p">.</span><span class="w"></span>
<span class="n">RUN</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">mvnw</span><span class="w"> </span><span class="nl">dependency</span><span class="p">:</span><span class="k">go</span><span class="o">-</span><span class="n">offline</span><span class="w"> </span><span class="o">-</span><span class="n">B</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Copy</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="n">source</span><span class="w"></span>
<span class="n">COPY</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="n">src</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Package</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">application</span><span class="w"></span>
<span class="n">RUN</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">mvnw</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="o">-</span><span class="n">DskipTests</span><span class="w"></span>
<span class="n">RUN</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">dependency</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">cd</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">dependency</span><span class="p">;</span><span class="w"> </span><span class="n">jar</span><span class="w"> </span><span class="o">-</span><span class="n">xf</span><span class="w"> </span><span class="p">..</span><span class="cm">/*.jar)</span>

<span class="cm">#### Stage 2: A minimal docker image with command to run the app</span>
<span class="cm">FROM openjdk:8-jre-alpine</span>

<span class="cm"># Copy project dependencies from the build stage</span>
<span class="cm">COPY --from=build /app/target/dependency/BOOT-INF/lib /app/lib</span>
<span class="cm">COPY --from=build /app/target/dependency/META-INF /app/META-INF</span>
<span class="cm">COPY --from=build /app/target/dependency/BOOT-INF/classes /app</span>

<span class="cm"># Define environment variables</span>
<span class="cm">ENV PROFILE=</span>
<span class="cm">ENV DB_IP=</span>
<span class="cm">ENV DB_USER=</span>
<span class="cm">ENV DB_PASSWD=</span>
<span class="cm">ENV LOGGING=</span>

<span class="cm">CMD java -Dspring.profiles.active=$PROFILE -Ddb_ip=$DB_IP -Ddb_user=$DB_USER \</span>
<span class="cm">    -Ddb_passwd=$DB_PASSWD -Dlogging=$LOGGING -cp app:app/lib/* madstodolist.Application</span>
</code></pre></div>
</td></tr></table>

<p>Se trata de un fichero que construye la imagen docker en dos fases. En
una primera fase compila la aplicación y guarda todos los <code>jars</code> en el
directorio <code>target</code>. En la segunda fase crea la máquina resultante, basada en
<code>openjdk:8-jre-alpine</code>, con las librerías compiladas previamente.</p>
<p>Docker permite definir variables de entorno que pueden ser modificadas
al lanzar la máquina. Definimos las mismas variables que hemos
definido en el fichero de propiedades de spring boot:</p>
<ul>
<li><code>PROFILE</code>: perfil a usar al lanzar la aplicación.</li>
<li><code>DB_IP</code>: dirección IP y puerto de la base de datos con la que se
  debe conectar la aplicación.</li>
<li><code>DB_USER</code>: usuario de la base de datos con el que la aplicación se
  conecta con la base de datos.</li>
<li><code>DB_PASSWD</code>: contraseña del usuario de la base de datos.</li>
<li><code>LOGGING</code>: nivel de logging que va a realizar la aplicación.</li>
</ul>
<p>Para lanzar una imagen docker definiendo un valor de una variable de
entorno hay que utilizar el flag <code>-e VARIABLE=valor</code>. </p>
<h3 id="pasos-a-seguir_4">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_4" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Crea una cuenta en <a href="https://hub.docker.com">DockerHub</a>. En esta
  cuenta se publicará la imagen docker de la aplicación.</p>
</li>
<li>
<p>Crea el fichero <code>Dockerfile</code> anterior en el directorio principal de
  la aplicación.</p>
</li>
<li>
<p>Construye la máquina docker. Utiliza como <em>usuario</em> el usuario que
  has creado en DockerHub.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker build -t USUARIO/mads-todolist-equipo-XX .</span>
</code></pre></div>
</td></tr></table>

<p>Prueba a ejecutar la aplicación trabajando con la base de datos en
memoria y con logs de nivel <code>INFO</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker run --rm -it -p 8080:8080 -e LOGGING=error USUARIO/mads-todolist-equipo-XX</span>
</code></pre></div>
</td></tr></table>

<p>El flag <code>-it</code> permite visualizar en el terminal de forma
interactiva la salida estándar de la aplicación Play y terminarla
haciendo un <code>CTRL-C</code>.</p>
<p>Y prueba por último a ejecutar la aplicación funcionando con la imagen docker
con la base de datos MySQL:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker run -d -p <span class="m">3306</span>:3306 --name mysql-develop -e <span class="nv">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class="o">=</span>yes -e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>mads mysql:5 
$ docker run --rm -it --link mysql-develop -p <span class="m">8080</span>:8080 <span class="se">\</span>
  -e <span class="nv">PROFILE</span><span class="o">=</span>mysql -e <span class="nv">DB_IP</span><span class="o">=</span>mysql-develop:3306 -e <span class="nv">DB_USER</span><span class="o">=</span>root -e <span class="nv">LOGGING</span><span class="o">=</span>info <span class="se">\</span>
  USUARIO/mads-todolist-equipo-XX
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Cuando compruebes que todo funciona correctamente, sube a <em>docker hub</em>
  la imagen compilada:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker login
<span class="c1"># introduce tus credenciales en docker hub</span>
$ docker push USUARIO/mads-todolist-equipo-XX
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Comprueba en <em>docker hub</em> que la imagen se ha subido
  correctamente. Uno de los compañeros debe probar que la imagen
  funciona correctamente, ejecutando las dos instrucciones
  anteriores en su máquina:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker run -d -p <span class="m">3306</span>:3306 --name mysql-develop -e <span class="nv">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class="o">=</span>yes -e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>mads mysql:5 
$ docker run --rm -it --link mysql-develop -p <span class="m">8080</span>:8080 <span class="se">\</span>
  -e <span class="nv">PROFILE</span><span class="o">=</span>mysql -e <span class="nv">DB_IP</span><span class="o">=</span>mysql-develop:3306 -e <span class="nv">DB_USER</span><span class="o">=</span>root -e <span class="nv">LOGGING</span><span class="o">=</span>info <span class="se">\</span>
  USUARIO/mads-todolist-equipo-XX
</code></pre></div>
</td></tr></table>

<p>Comprobad que se descarga correctamente la máquina
<code>USUARIO/mads-todolist-equipo-XX</code> y que la aplicación se lanza sin
errores.</p>
</li>
<li>
<p>Por último, modifica el script de Travis para que sea Travis quien
  construya y publique la máquina docker. Antes de que se ejecute el
  script deberás configurar en los ajustes del repositorio en Travis
  (<em>travis-ci.com &gt; USUARIO/mads-todolist-equipo-XX &gt; Settings &gt;
  Environment Variables</em>) las variables: <code>DOCKER_USERNAME</code> y
  <code>DOCKER_PASSWORD</code>, para que Travis pueda publicar en tu cuenta de
  DockerHub.</p>
<p><img src="imagenes/variables-entorno-travis.png" width="700px"/></p>
<p>Líneas a añadir al final del fichero <code>.travis.yml</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c">after_success:</span>
<span class="c">  - docker build -t USUARIO/mads-todolist-equipo-XX:$TRAVIS_BUILD_NUMBER .</span>
<span class="c">  - if [ &quot;$TRAVIS_EVENT_TYPE&quot; != &quot;pull_request&quot; ]; then</span>
<span class="c">    docker login -u=&quot;$DOCKER_USERNAME&quot; -p=&quot;$DOCKER_PASSWORD&quot;;</span>
<span class="c">    docker push USUARIO/mads-todolist-equipo-XX:$TRAVIS_BUILD_NUMBER;</span>
<span class="c">    docker tag USUARIO/mads-todolist-equipo-XX:$TRAVIS_BUILD_NUMBER USUARIO/mads-todolist-equipo-XX:latest;</span>
<span class="c">    docker push USUARIO/mads-todolist-equipo-XX:latest;</span>
<span class="c">    fi</span>
</code></pre></div>
</td></tr></table>

<p>Fíjate en el script <code>after_success</code>. Es lo que Travis hará después
de ejecutar con éxito los tests:</p>
<ul>
<li>Construir la máquina docker de nuestra aplicación, asignándole
como etiqueta el número de build actuar.</li>
<li>Si la ejecución de Travis es debida a un evento que no es un
<em>pull request</em> (o sea, cuando sea un build disparado por el commit
de merge con la rama en la que se integra el PR) se logea en
docker hub con el usuario y la contraseña definidas en las
variables. Una vez logeado, publica la imagen usando como número
de <em>tag</em> el número de build. Y esta última imagen también se
vuelve a etiquetar como <code>latest</code> y se vuelve a subir.</li>
</ul>
<p>Por ejemplo, cuando se realice el build <code>#28</code> se publicará la
imagen resultante de este build con las etiquetas <code>28</code> y <code>latest</code>:
<code>USUARIO/mads-todolist-equipo-XX:28</code> y
<code>USUARIO/mads-todolist-equipo-XX:latest</code>.</p>
</li>
<li>
<p>Por último, añade el siguiente fichero <code>docker-compose.yml</code> en el
  directorio raíz de la aplicación. La aplicación <code>docker-compose</code>
  permite automatizar la puesta en funcionamiento y conexión de más de
  un contenedor docker. En nuestro caso, servirá para poner en marcha
  con un único comando el contenedor de base de datos y nuestra
  aplicación.</p>
<p>Fichero <code>docker-compose.yml</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">version</span><span class="p">:</span> <span class="s1">&#39;3.7&#39;</span>

<span class="o">#</span> <span class="n">Define</span> <span class="n">services</span>
<span class="n">services</span><span class="p">:</span>

  <span class="o">#</span> <span class="n">App</span> <span class="n">backend</span> <span class="n">service</span>
  <span class="n">mads</span><span class="o">-</span><span class="n">todolist</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">USUARIO</span><span class="o">/</span><span class="n">mads</span><span class="o">-</span><span class="n">todolist</span><span class="o">-</span><span class="n">equipo</span><span class="o">-</span><span class="n">XX</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="ss">&quot;8080:8080&quot;</span> <span class="o">#</span> <span class="k">Forward</span> <span class="n">the</span> <span class="n">exposed</span> <span class="n">port</span> <span class="mi">8080</span> <span class="k">on</span> <span class="n">the</span> <span class="n">container</span> <span class="k">to</span> <span class="n">port</span> <span class="mi">8080</span> <span class="k">on</span> <span class="n">the</span> <span class="k">host</span> <span class="n">machine</span>
    <span class="k">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">depends_on</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">db</span> <span class="o">#</span> <span class="n">This</span> <span class="n">service</span> <span class="n">depends</span> <span class="k">on</span> <span class="n">mysql</span><span class="p">.</span> <span class="k">Start</span> <span class="n">that</span> <span class="k">first</span><span class="p">.</span>
    <span class="n">environment</span><span class="p">:</span> <span class="o">#</span> <span class="n">Pass</span> <span class="n">environment</span> <span class="n">variables</span> <span class="k">to</span> <span class="n">the</span> <span class="n">service</span>
      <span class="n">PROFILE</span><span class="p">:</span> <span class="n">mysql</span>
      <span class="n">DB_IP</span><span class="p">:</span> <span class="n">db</span><span class="p">:</span><span class="mi">3306</span>
      <span class="n">DB_USER</span><span class="p">:</span> <span class="n">root</span>
      <span class="n">LOGGING</span><span class="p">:</span> <span class="n">info</span>
    <span class="n">networks</span><span class="p">:</span> <span class="o">#</span> <span class="n">Networks</span> <span class="k">to</span> <span class="k">join</span> <span class="p">(</span><span class="n">Services</span> <span class="k">on</span> <span class="n">the</span> <span class="n">same</span> <span class="n">network</span> <span class="n">can</span> <span class="n">communicate</span> <span class="k">with</span> <span class="k">each</span> <span class="n">other</span> <span class="k">using</span> <span class="n">their</span> <span class="n">name</span><span class="p">)</span>
      <span class="o">-</span> <span class="n">backend</span>

  <span class="o">#</span> <span class="k">Database</span> <span class="n">Service</span> <span class="p">(</span><span class="n">Mysql</span><span class="p">)</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="mi">5</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="ss">&quot;3306:3306&quot;</span>
    <span class="k">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="n">MYSQL_DATABASE</span><span class="p">:</span> <span class="n">mads</span>
      <span class="n">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">db</span><span class="o">-</span><span class="k">data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
    <span class="n">networks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">backend</span>

<span class="o">#</span> <span class="n">Volumes</span>
<span class="n">volumes</span><span class="p">:</span>
  <span class="n">db</span><span class="o">-</span><span class="k">data</span><span class="p">:</span>

<span class="o">#</span> <span class="n">Networks</span> <span class="k">to</span> <span class="n">be</span> <span class="n">created</span> <span class="k">to</span> <span class="n">facilitate</span> <span class="n">communication</span> <span class="k">between</span> <span class="n">containers</span>
<span class="n">networks</span><span class="p">:</span>
  <span class="n">backend</span><span class="p">:</span>
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Prueba que funciona correctamente <code>docker-compose</code> ejecutando el
    comando <code>docker-compose up</code>. Para asegurarte de que la imagen que
    ejecutas es la que se descarga de docker hub debes borrar
    previamente la imagen que tengas en tu ordendador:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker container prune
$ docker image rm USUARIO/mads-todolist-equipo-XX
$ docker-compose up
</code></pre></div>
</td></tr></table>

<p>Verás cómo se ponen en marcha el contenedor <code>mysql</code> y el
contenedor con nuestra aplicación. Prueba a conectarte a la
aplicación y comprobar que todo funciona correctamente.
Puedes terminar la ejecución
haciendo <code>CTRL-C</code> o lanzando desde otra terminal el comando</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker-compose down</span>
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>En el script de <code>docker-compose</code> el contenedor <code>mysql</code> utiliza un
    <a href="https://docs.docker.com/storage/volumes/">volumen</a>. Esto permite
    conservar los datos que se introduzcan en la ejecución del
    programa, aunque el contenedor se borre. También sería posible
    hacer un backup de estos datos a partir del volumen.</p>
<p>Para listar los volúmenes mantenidos por docker:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker volume ls</span>
</code></pre></div>
</td></tr></table>

<p>Para eliminar un volumen:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker volume rm nombre-volumen</span>
</code></pre></div>
</td></tr></table>

<p>Y para elminar todos los volúmenes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker volume prune</span>
</code></pre></div>
</td></tr></table>

</li>
<li>
<p>Haz un commit y sube los cambios a GitHub. </p>
</li>
<li>
<p>Crea el pull request que cierra el <em>issue</em> y ciérralo, comprobando
  que Travis construye la máquina docker y la publica en docker hub.</p>
<p><img src="imagenes/imagenes-docker-hub.png" width="700px"/></p>
</li>
<li>
<p>Por último un compañero debe probar el comando <code>docker-compose up</code> y
  comprobar si se ponen en marcha las imágenes docker y nuestra
  aplicación funciona correctamente. </p>
</li>
</ul>
<h2 id="entrega-y-evaluacion">Entrega y evaluación<a class="headerlink" href="#entrega-y-evaluacion" title="Permanent link">&para;</a></h2>
<ul>
<li>La práctica tiene una duración de 3 semanas y debe estar terminada
  el martes 26 de noviembre.</li>
<li>La calificación de la práctica tiene un peso de un 5% en la nota
  final de la asignatura.</li>
<li>Para realizar la entrega uno de los miembros del equipo debe subir a
  Moodle un ZIP que contenga todo el proyecto, incluyendo el
  directorio <code>.git</code> que contiene la historia Git. Para ello comprime
  tu directorio local del proyecto <strong>después de haber hecho un <code>mvn
  clean</code></strong> para eliminar el directorio <code>target</code> que contiene los
  binarios compilados. Debes dejar también en Moodle la URL del
  repositorio en GitHub.</li>
</ul>
<p>Para la evaluación se tendrá en cuenta:</p>
<ul>
<li>Desarrollo continuo (los <em>commits</em> deben realizarse a lo largo de
  las semanas y no dejar todo para la última).</li>
<li>Correcto desarrollo de la metodología.</li>
<li>Corrección del código.</li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../02-pruebas-tdd/integration-tdd.html" title="Práctica 2" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Anterior
                </span>
                Práctica 2
              </span>
            </div>
          </a>
        
        
          <a href="../04-iteracion-scrum/iteracion-scrum.html" title="Práctica 4" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Siguiente
                </span>
                Práctica 4
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>