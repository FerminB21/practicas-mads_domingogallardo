



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Práctica 3: Trabajo en equipo GitFlow y despliegue de la aplicación - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Helvetica:300,400,400i,700|Source+Code+Pro">
        <style>body,input{font-family:"Helvetica","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#practica-3-trabajo-en-equipo-gitflow-y-despliegue-de-la-aplicacion" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Prácticas MADS" class="md-header-nav__button md-logo">
          
            <img src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Prácticas MADS
            </span>
            <span class="md-header-nav__topic">
              Práctica 3: Trabajo en equipo GitFlow y despliegue de la aplicación
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo">
      
        <img src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Práctica 0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Práctica 0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/intro-spring-boot.html" title="Introducción a Sprign Boot para MADS" class="md-nav__link">
      Introducción a Sprign Boot para MADS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/comandos-git.html" title="Comandos Git" class="md-nav__link">
      Comandos Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica0.html" title="Práctica 0" class="md-nav__link">
      Práctica 0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica1.html" title="Práctica 1" class="md-nav__link">
      Práctica 1
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-pruebas-tdd/integration-tdd.html" title="Práctica 2" class="md-nav__link">
      Práctica 2
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objetivos-y-resumen-de-la-practica" title="Objetivos y resumen de la práctica" class="md-nav__link">
    Objetivos y resumen de la práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formacion-de-equipos" title="Formación de equipos" class="md-nav__link">
    Formación de equipos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuevo-flujo-de-trabajo-para-los-issues" title="Nuevo flujo de trabajo para los issues" class="md-nav__link">
    Nuevo flujo de trabajo para los issues
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comandos-git" title="Comandos Git" class="md-nav__link">
    Comandos Git
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-gitflow" title="Configuración de GitFlow" class="md-nav__link">
    Configuración de GitFlow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ramas-de-largo-recorrido" title="Ramas de largo recorrido" class="md-nav__link">
    Ramas de largo recorrido
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ramas-de-feature" title="Ramas de feature" class="md-nav__link">
    Ramas de feature
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ramas-de-release" title="Ramas de release" class="md-nav__link">
    Ramas de release
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#despliegue" title="Despliegue" class="md-nav__link">
    Despliegue
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gestion-de-la-base-de-datos-de-produccion" title="Gestión de la base de datos de producción" class="md-nav__link">
    Gestión de la base de datos de producción
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion-de-la-aplicacion-en-produccion" title="Ejecución de la aplicación en producción" class="md-nav__link">
    Ejecución de la aplicación en producción
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-y-evaluacion" title="Entrega y evaluación" class="md-nav__link">
    Entrega y evaluación
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="practica-3-trabajo-en-equipo-gitflow-y-despliegue-de-la-aplicacion">Práctica 3: Trabajo en equipo GitFlow y despliegue de la aplicación<a class="headerlink" href="#practica-3-trabajo-en-equipo-gitflow-y-despliegue-de-la-aplicacion" title="Permanent link">&para;</a></h1>
<h2 id="objetivos-y-resumen-de-la-practica">Objetivos y resumen de la práctica<a class="headerlink" href="#objetivos-y-resumen-de-la-practica" title="Permanent link">&para;</a></h2>
<p>En esta práctica se pretende conseguir:</p>
<ol>
<li>Crear los equipos de trabajo en GitHub</li>
<li>Adaptar el flujo de trabajo en Git y GitHub al trabajo en equipo.<ul>
<li>Implementar GitFlow.</li>
<li>Desarrollar nuevas features con GitFlow.</li>
<li>Lanzamiento de una versión nueva usando GitFlow.</li>
</ul>
</li>
<li>Despliegue de la nueva versión en producción.</li>
</ol>
<h2 id="formacion-de-equipos">Formación de equipos<a class="headerlink" href="#formacion-de-equipos" title="Permanent link">&para;</a></h2>
<p>En esta práctica comenzamos a trabajar en equipos de 3 personas (de
forma excepcional podrían ser 2 o 4 personas).</p>
<p>Cada equipo trabajará con un repositorio común seleccionado de uno de
los miembros del equipo. Se formará también un <em>team</em> en la
organización <code>mads-ua-18</code> en el que participarán todos los miembros
del equipo.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/03-gitflow-despliegue/imagenes/equipos-mads-ua.png" width="700px"/></p>
<p>Utilizaremos <em>GitHub Classroom</em> para crear el <em>team</em> y el repositorio.</p>
<h3 id="pasos-a-seguir">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Debéis formar equipos de <strong>3 personas</strong>. Enviad los componentes al
  foro de Moodle y os asignaré un nombre de equipo. Utilizad después
  el enlace de GitHub Classroom que enviaré al foro de Moodle para
  crear el equipo y apuntaros a él.</p>
<p>El equipo trabajará con un repositorio creado por GitHub Classroom
con el nombre <code>todolistgrupo-2018-NOMBRE-EQUIPO</code>. Al igual que en
la práctica 1, el repositorio se creará en el grupo <code>mads-ua-18</code>.</p>
</li>
<li>
<p>Una vez creado el repositorio debéis crear en él un tablero para
  gestionar las tarjetas con los <em>issues</em> y los pull
  requests. Creadlos con las mismas columnas que en las prácticas 1 y 2.</p>
</li>
<li>
<p>Escoged el proyecto que vais a usar en estas dos últimas prácticas
  de entre los proyectos de los miembros del equipo. Intentad que se
  un proyecto con código limpio y fácilmente ampliable.</p>
<p>Subidlo al nuevo repositorio, cambiando la URL del <code>origin</code> del
repositorio local y haciendo un push:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git remote set-url origin https://github.com/mads-ua-18/todolistgrupo-2018-NOMBRE-EQUIPO.git
$ git push -u origin master
</pre></div>
</td></tr></table>

<p>Por último, los otros miembros del equipo deberán clonar el
repositorio para que los tres podáis trabajar con él en local.</p>
</li>
<li>
<p>Cambiad el nombre del proyecto en el fichero <code>build.sbt</code> a
  <code>mads-todolist-equipo-XX</code>. También deberéis cambiar el fichero
  <code>Dockerfile</code> para actualizar el nombre de la aplicación a ejecutar,
  y el fichero <code>.travis.yml</code> para modificar el nombre de la máquina a
  publicar en Docker Hub (podéis llamarla también
  <code>mads-todolist-equipo-XX</code>). Podéis usar como usuario de Docker Hub
  el propietario del repositorio escogido.</p>
<p>Haced un commit directamente en <code>master</code> con estos cambios.</p>
<p>Para conectar el repositorio con Travis hay que acceder a la
cuenta personal en Travis.com y sincronizar el nuevo repositorio
<code>todolistgrupo</code> en la organización <code>mads-ua-18</code>. Puedes acceder a
la página para sincronizar este nuevo repositorio desde la página
principal de Travis, pulsando el botón <code>+</code>:</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/03-gitflow-despliegue/imagenes/builds-travis-add.png" width="600px"/></p>
<p>Aseguraos que funciona correctamente la nueva imagen subida
probando a ejecutar la aplicación:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -it --rm -p <span class="m">9000</span>:9000 <span class="p">&amp;</span>lt<span class="p">;</span>usuario<span class="p">&amp;</span>gt<span class="p">;</span>/mads-todolist-equipo-XX
</pre></div>
</td></tr></table>

<p>El flag <code>-it</code> permite visualizar en el terminal de forma interactiva
la salida estándar de la aplicación Play y terminarla haciendo un <code>CTRL-C</code>.</p>
</li>
</ul>
<h2 id="nuevo-flujo-de-trabajo-para-los-issues">Nuevo flujo de trabajo para los <em>issues</em><a class="headerlink" href="#nuevo-flujo-de-trabajo-para-los-issues" title="Permanent link">&para;</a></h2>
<p>Debemos adaptar el flujo de trabajo en GitHub al trabajo en equipo. En
cuanto a la gestión de los <em>issues</em> y tablero del proyecto cambiaremos
lo siguiente:</p>
<ul>
<li><strong>Selección del <em>issue</em></strong>: Al pasar un <em>issue</em> de <code>To do</code>a <code>In
  progress</code> se debe asignar un responsable.</li>
<li><strong>Nueva rama con el <em>issue</em></strong>: El responsable será el que abra una
  rama nueva para el desarrollo del ticket y la subirá a
  GitHub.</li>
<li><strong>Desarrollo</strong>: Se trabaja en la rama. Cualquier compañero puede
  unirse al ticket y trabajar junto con el responsable.</li>
<li><strong>Pull request</strong>: Cuando el ticket se ha terminado, el responsable
  abre un pull request en GitHub y pone la tarjeta en la columna
  <code>In pull request</code>.</li>
<li><strong>Revisión de código</strong>: Los miembros del equipo revisan el código en
  el pull request (consultar documentación en GitHub: <a href="https://help.github.com/articles/reviewing-proposed-changes-in-a-pull-request/">Reviewing
  proposed changes in a pull
  request</a>). Al
  final, todos los miembros del equipo deben dar el OK, añadiendo una
  reacción.</li>
<li><strong>Integración del pull request</strong>: Cuando todos dan el OK, el
  responsable de la tarea integra el pull request.</li>
</ul>
<p>Para implementar el trabajo en equipo será necesario trabajar sobre
ramas remotas compartidas. A continuación explicamos con más detalle
algunos aspectos comandos de Git necesarios.</p>
<h3 id="comandos-git">Comandos Git<a class="headerlink" href="#comandos-git" title="Permanent link">&para;</a></h3>
<p>Veamos algunos comandos de Git relacionados con el trabajo compartido
en repositorios y ramas remotas.</p>
<ul>
<li>
<p>Subir una rama al repositorio remoto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git checkout -b nueva-rama
$ git push -u origin nueva-rama
</pre></div>
</td></tr></table>

</li>
<li>
<p>Descargar una rama del repositorio remoto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git fetch 
$ git checkout nueva-rama
</pre></div>
</td></tr></table>

<p>El comando <code>git fetch</code> se descarga todos los cambios pero no los
mezcla con las ramas locales. Los deja en ramas cacheadas a las
que les da el nombre del servidor y la rama
(<code>origin/nueva-rama</code>). </p>
<p>En el caso del comando anterior, el comando <code>git checkout
nueva-rama</code> es equivalente a <code>git checkout -b nueva-rama
origin/nueva-rama</code>. Se crea una rama local <code>nueva-rama</code> conectada
a la rama <code>origin/nueva-rama</code>.</p>
</li>
<li>
<p>Actualizar una rama con cambios que otros compañeros han subido al
  repositorio remoto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git pull
</pre></div>
</td></tr></table>

<p>El comando <code>git pull</code> es equivalente a un <code>git fetch</code> seguido de
un <code>git merge</code>. El comando <code>git fetch</code> actualiza la rama remota
<code>origin/nueva-rama</code>. El comando <code>git pull</code> es equivalente a hacer:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git checkout nueva-rama
$ git fetch
$ git merge origin/nueva-rama
</pre></div>
</td></tr></table>

</li>
<li>
<p>Subir cambios de la rama actual:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>(estando en la rama que queremos subir)
$ git push
</pre></div>
</td></tr></table>

<p>El comando <code>git push</code> funcionará correctamente sin más parámetros
si previamente hemos subido la rama con un <code>git push -u</code>.</p>
</li>
<li>
<p>Comprobar el estado de las ramas locales y remotas:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git branch -vv
</pre></div>
</td></tr></table>

<p>Este comando no accede directamente al servidor, sino que muestra
la información de la última vez que se accedió a él. Si queremos
la información actualizada podemos hacer un <code>git fetch --all</code>
antes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git fetch --all
$ git branch -vv
</pre></div>
</td></tr></table>

<p>Es importante recordar que <code>git fetch</code> (a diferencia de <code>git
pull</code>) no modifica los repositorios locales, sino que baja las
ramas remotas cachés locales.</p>
</li>
<li>
<p>Información de los repositorios remotos:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git remote show origin
</pre></div>
</td></tr></table>

<p>Proporciona información del repositorio remoto, todas sus ramas,
del local y de la conexión entre ambos.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git remote -v update
</pre></div>
</td></tr></table>

<p>Proporciona información del estado de las ramas remotas y locales
(si están actualizadas o hay cambios en algunas no bajadas o
subidas).</p>
</li>
<li>
<p>Borrado de ramas remotas desde el terminar:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git push origin --delete nueva-rama
$ git remote prune origin
</pre></div>
</td></tr></table>

</li>
<li>
<p>Si necesitamos en la rama de <em>feature</em> código que se haya añadido en
  la rama <code>master</code>.</p>
<p>Podemos hacer un <em>merge</em> de la rama <code>master</code> en la rama de
<em>feature</em> para incorporar los avances de código que se han hecho
en <code>master</code> y que necesitamos en nuestra nueva rama:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git checkout nueva-rama
$ git merge master
</pre></div>
</td></tr></table>

</li>
<li>
<p>Solución de conflictos en un <em>pull request</em>:</p>
<p>Recordamos lo que hemos visto en teoría sobre la solución de
conflictos detectados en un <em>pull request</em>.</p>
<p>Supongamos que hay un conflicto entre la nueva rama y
<code>master</code>. GitHub detectará el conflicto en la página de <em>pull
request</em>. Para arreglar el conflicto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git checkout master
$ git pull
$ git checkout nueva-rama
$ git merge master
<span class="c1"># arreglar el conflicto</span>
$ git push
<span class="c1"># ya se puede hacer el merge en GitHub</span>
</pre></div>
</td></tr></table>

</li>
</ul>
<h3 id="pasos-a-seguir_1">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_1" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Probad el nuevo flujo de trabajo en el tablero del proyecto creando
  un nuevo <em>issue</em> denominado <code>Actualizar la página Acerca de</code>. En la
  descripción de <em>issue</em> comentad que se debe modificar la página para
  que muestren todos los miembros del equipo y el nuevo número de
  versión de la aplicación (<code>1.3.0-SNAPSHOT</code>).</p>
</li>
<li>
<p>Escoged una persona del equipo como responsable del <em>issue</em>. El
  responsable del <em>issue</em> será el responsable de integrarlo en
  <code>master</code> y de solucionar los conflictos que puedan surgir.</p>
</li>
<li>
<p>Probad los comandos Git anteriores en una rama en la que se resuelva
  el <em>issue</em>. Cada miembro del equipo deberá realizar un commit en el
  que se añada su nombre a la lista de autores de la aplicación.</p>
</li>
<li>
<p>Cread el pull request en GitHub, poniendo como responsable del PR al
  mismo responsable del <em>issue</em>.</p>
</li>
<li>
<p>Provocad un conflicto y arregladlo. Para ello se debe añadir un
  commit en <code>master</code> que entre en conflicto con los cambios realizados
  en la rama. Después se arreglará el conflicto y se subirá la
  solución al pull request.</p>
</li>
<li>
<p>Por último, revisad el código, aceptadlo e integrad el PR en <em>master</em>.</p>
</li>
</ul>
<h2 id="configuracion-de-gitflow">Configuración de GitFlow<a class="headerlink" href="#configuracion-de-gitflow" title="Permanent link">&para;</a></h2>
<p>El flujo de trabajo Git que vamos a seguir es muy similar al flujo de
trabajo GitFlow (recordad la <a href="https://github.com/domingogallardo/apuntes-mads/blob/master/sesiones/07-git-workflows/git-workflows.md">clase de
teoría</a>). Pero
vamos a introducir alguna variante en la nomenclatura de las ramas.</p>
<h3 id="ramas-de-largo-recorrido">Ramas de largo recorrido<a class="headerlink" href="#ramas-de-largo-recorrido" title="Permanent link">&para;</a></h3>
<p>En GitFlow se publican las distintas versiones del proyecto en la rama
<em>long-lived</em> <code>master</code> y se hace el desarrollo en la rama
<code>develop</code>. A partir de ahora no desarrollaremos directamente en
<code>master</code> sino en <code>develop</code>.</p>
<p>En la página de configuración del repositorio en GitHub en <code>Settings &gt;
Branches &gt; Default branch</code> se puede configurar la rama por defecto
contra la que se realizarán los commits y la que aparecerá en la
página del proyecto. Tendréis que definir <code>develop</code>.</p>
<h3 id="ramas-de-feature">Ramas de feature<a class="headerlink" href="#ramas-de-feature" title="Permanent link">&para;</a></h3>
<p>Desde el comienzo de trabajo con Git en las prácticas 1 y 2 estamos
haciendo un desarrollo basado en ramas de corto recorrido,
equivalentes a las ramas de <em>features</em> de GitFlow. </p>
<p>Tal y como se comenta en GitFLow estas ramas saldrán de <code>develop</code> y se
integrarán en <code>develop</code>. La diferencia es que en GitFlow estas ramas
se integran con la rama de desarrollo manualmente haciendo <code>merge</code>,
mientras que nosotros las integramos haciendo un pull request.</p>
<h3 id="ramas-de-release">Ramas de release<a class="headerlink" href="#ramas-de-release" title="Permanent link">&para;</a></h3>
<p>Hasta ahora hemos hecho los <em>releases</em> en la rama <code>master</code>. A partir
de ahora seguiremos la estrategia de GitFlow y haremos ramas de
<em>release</em> que salen de <code>develop</code> y se integran en <code>master</code> y en
<code>develop</code>.</p>
<p>Haremos también la integración haciendo pull request.</p>
<h3 id="pasos-a-seguir_2">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_2" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>El equipo elegirá un <strong>responsable de integración</strong> que se encargue de
crear la rama <strong><code>develop</code></strong> y configurarla como rama principal del
proyecto en GitHub. Todos los otros miembros deberán descargarla y
moverse a ella en sus repositorios locales. Esta rama pasará a ser la
de desarrollo principal. </p>
</li>
<li>
<p>Habrá que modificar el fichero de configuración de Travis, para que
también se lancen los builds en esta rama.</p>
</li>
<li>
<p>Haced un PR de prueba en la rama <code>develop</code> para comprobar que todo
  funciona bien.</p>
</li>
<li>
<p>Cread un <em>issue</em> con la tarea <em>Lanzar release 1.3.0</em> que tendrá como
responsable también al responsable de integración.</p>
</li>
<li>
<p>El responsable de integración deberá publicar la nueva versión
siguiendo los pasos de GitFlow:</p>
<ul>
<li>Crear la rama local <strong><code>release-1.3.0</code></strong> a partir de <code>develop</code>.</li>
<li>Realizar en esta rama los cambios específicos de la versión. En
  nuestro caso:<ul>
<li>Cambiar en la página "Acerca de" "Versión 1.3.0-SNAPSHOT" a
  "Versión 1.3.0" y añadir la fecha de publicación.</li>
<li>Cambiar el fichero <code>build.sbt</code>.</li>
</ul>
</li>
<li>Publicar la rama <code>release-1.3.0</code> en GitHub y hacer un pull
  request sobre <code>master</code>. Una vez mezclado el PR añadir la
  etiqueta con la nueva versión <code>1.3.0</code> en <code>master</code> creando la
  página de release en GitHub. </li>
<li>Mezclar también la rama de release con <code>develop</code> (se puede hacer
  también con un PR).</li>
<li>Por último, subir a Docker Hub la nueva versión 1.3.0. Docker
  Hub hace el papel de "repositorio de artefactos" de nuestra
  cadena de integración continua. Publicaremos allí todas las
  releases compiladas en forma de imágenes docker que vayamos
  generando.</li>
</ul>
</li>
<li>
<p>Una vez hecho esto ya se puede borrar la rama <code>release-1.3.0</code> y las
  ramas <code>master</code> y <code>develop</code> estarán actualizadas a las nuevas
  versiones.</p>
</li>
<li>
<p>La rama <code>develop</code> también será integrada por Travis. Debemos
comprobar que pasan todos los tests y que sube a Docker Hub la imagen
con la etiqueta <code>latest</code>.</p>
</li>
<li>
<p>Por último, deberéis realizar un <em>hot fix</em>, siguiendo el flujo de
  trabajo de GitFlow, y actualizando el número de versión a <code>1.3.1</code>.</p>
</li>
</ul>
<h2 id="despliegue">Despliegue<a class="headerlink" href="#despliegue" title="Permanent link">&para;</a></h2>
<p>El objetivo del despliegue es poner en producción la última versión
lanzada de la aplicación. Como no ha sido posible encontrar ningún
servicio gratuito de hosting que soporte Play Framework (o Docker) y
MySQL, se realizará el despliegue en un ordenador de uno de los
miembros del equipo.</p>
<p>El <strong>responsable de despliegue</strong> deberá desplegar la aplicación docker
correspondiente a la última versión (que se estará publicada en Docker
Hub).  Deberá realizar el despliegue en modo producción, trabajando
con el fichero de configuración <code>production.conf</code>, y sobre una base de
datos de producción MySQL que contendrá todos los datos guardados en
todas las ejecuciones de la aplicación en este entorno de producción.</p>
<p>Para que funcione correctamente, se deberá actualizar el esquema de
datos de la base de datos de producción en el caso en que se haya
modificado dicho esquema en el desarrollo.</p>
<p>Vamos a ver primero los elementos que necesitamos para realizar el
despliegue y después enumeraremos paso a paso las actividades a
realizar en la práctica.</p>
<h3 id="gestion-de-la-base-de-datos-de-produccion">Gestión de la base de datos de producción<a class="headerlink" href="#gestion-de-la-base-de-datos-de-produccion" title="Permanent link">&para;</a></h3>
<p>La base de datos de producción deberá crearse inicialmente con el
esquema de datos necesario. Después deberá actualizarse con cada nueva
versión que modifique el esquema de datos.</p>
<p>La base de datos de producción contendrá todos los datos introducidos
por distintas pruebas realizadas, simulando usuarios reales que
utilizan la aplicación.</p>
<h4>Exportación del esquema de datos inicial</h4>
<p>Para conseguir el esquema de datos inicial de la aplicación podemos
exportarlo una vez creado por la aplicación ejecutándose en modo
develop.</p>
<p>Para ello lanzamos la aplicación como lo hemos hecho hasta ahora,
trabajando contra el contenedor MySQL recién arrancado. Al arrancar la
aplicación JPA crea en la base de datos el esquema necesario para que
la aplicación funcione.  No hace falta añadir ningún dato, porque solo
nos interesa el esquema de datos.  </p>
<p>Una incializado el esquema de datos podemos exportarlo con el
siguiente comando <code>mysqldum</code> lanzado al contenedor <code>db-mysql</code> en
marcha:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker exec db-mysql sh -c &#39;exec mysqldump --no-data mads -uroot -pmads&#39; &gt; schema.sql
</pre></div>
</td></tr></table>

<p>El comando anterior ejecuta el comando <code>mysqldump</code> en el contenedor
docker. Este comando exporta el esquema de datos (sin los datos
añadidos) y lo graba el fichero <code>schema.sql</code> en el directorio
actual. </p>
<p>El fichero debería ser parecido a este:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">-- MySQL dump 10.13  Distrib 5.7.23, for Linux (x86_64)</span>
<span class="c1">--</span>
<span class="c1">-- Host: localhost    Database: mads</span>
<span class="c1">-- ------------------------------------------------------</span>
<span class="c1">-- Server version   5.7.23</span>

<span class="cm">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span><span class="p">;</span>
<span class="cm">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span><span class="p">;</span>
<span class="cm">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span><span class="p">;</span>
<span class="cm">/*!40101 SET NAMES utf8 */</span><span class="p">;</span>
<span class="cm">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span><span class="p">;</span>
<span class="cm">/*!40103 SET TIME_ZONE=&#39;+00:00&#39; */</span><span class="p">;</span>
<span class="cm">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span><span class="p">;</span>
<span class="cm">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span><span class="p">;</span>
<span class="cm">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#39;NO_AUTO_VALUE_ON_ZERO&#39; */</span><span class="p">;</span>
<span class="cm">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Admin`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="k">Admin</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="k">Admin</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">usuario_id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">usuario_id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">FKk02c1a5a0iytp4s5ijsk8i038</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">usuario_id</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">Usuario</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Equipo`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Equipo</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Equipo</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">nombre</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Equipo_Usuario`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Equipo_Usuario</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Equipo_Usuario</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">fk_equipo</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">fk_usuario</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_equipo</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">fk_usuario</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">FKfhluff2qt31bph8boc2xiadfd</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_usuario</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">FKfhluff2qt31bph8boc2xiadfd</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_usuario</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">Usuario</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">FKhiod88sx7eufxk2p9379o37wh</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_equipo</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">Equipo</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Etiqueta`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Etiqueta</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Etiqueta</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">texto</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Etiqueta_Tarea`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Etiqueta_Tarea</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Etiqueta_Tarea</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">fk_etiqueta</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">fk_tarea</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_etiqueta</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">fk_tarea</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">FKpok50kklbh3b9c4h3gyxug37a</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_tarea</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">FK2x5gddvr7tkl4crl8dgcxiojc</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_etiqueta</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">Etiqueta</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">FKpok50kklbh3b9c4h3gyxug37a</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">fk_tarea</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">Tarea</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Tarea`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Tarea</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Tarea</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">titulo</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">usuarioId</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">FKepne2t52y8dmn8l9da0dd7l51</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">usuarioId</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">FKepne2t52y8dmn8l9da0dd7l51</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">usuarioId</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">Usuario</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `Usuario`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Usuario</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Usuario</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">apellidos</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">email</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">fechaNacimiento</span><span class="o">`</span> <span class="nb">date</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">login</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">nombre</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>

<span class="c1">--</span>
<span class="c1">-- Table structure for table `hibernate_sequence`</span>
<span class="c1">--</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hibernate_sequence</span><span class="o">`</span><span class="p">;</span>
<span class="cm">/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = utf8 */</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">hibernate_sequence</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">next_val</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="p">;</span>
<span class="cm">/*!40101 SET character_set_client = @saved_cs_client */</span><span class="p">;</span>
<span class="cm">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span><span class="p">;</span>

<span class="cm">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span><span class="p">;</span>
<span class="cm">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span><span class="p">;</span>
<span class="cm">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span><span class="p">;</span>
<span class="cm">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span><span class="p">;</span>
<span class="cm">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span><span class="p">;</span>
<span class="cm">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span><span class="p">;</span>
<span class="cm">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span><span class="p">;</span>

<span class="c1">-- Dump completed on 2018-10-30 10:50:52</span>
</pre></div>
</td></tr></table>

<h4>Inicialización de la imagen docker MySQL</h4>
<p>Para inicializar los datos de la base de datos de producción 
podemos utilizar el directorio <code>/docker-entrypoint-initdb.d</code>. Lo
primero que hace el contenedor docker recién inicializado es consultar
ese directorio y ejecutar todos los ficheros con la extensión <code>.sql</code>
que encuentre ahí. Los ejecuta en el orden alfabético del nombre de
fichero.</p>
<p>Por ejemplo, si colocamos el fichero <code>backup.sql</code> en el directorio
actual, podemos lanzar el contenedor docker de la siguiente forma, para
que cargue este fichero nada más arrancar:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -d --name db-mysql -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>:/docker-entrypoint-initdb.d -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>mads -e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>mads mysql:5
</pre></div>
</td></tr></table>

<p>De esta forma se lanza MySQL cargando el esquema y los datos que hayamos
incluido en el fichero <code>backup.sql</code>.</p>
<h4>Grabado de los datos</h4>
<p>Es posible volcar los datos de la base de datos del contenedor
de producción con el siguiente comando:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker <span class="nb">exec</span> db-mysql sh -c <span class="s1">&#39;exec mysqldump mads -uroot -pmads&#39;</span> &gt; backup.sql
</pre></div>
</td></tr></table>

<p>De esta forma podemos hacer una copia de seguridad de los datos
añadidos y del esquema de datos actual.</p>
<h4>Actualización del esquema de datos</h4>
<p>Cuando se despliegue una nueva versión de la aplicación que contenga un
cambio en el modelo de datos se deberá actualizar el esquema de datos
de la base de datos para que la aplicación funcione
correctamente. Esta actualización deberá hacerse sin modificar los
datos existentes.</p>
<p>Para ello, definiremos un fichero <code>upgradeXXX.sql</code> en el que
introduciremos las instrucciones necesarias para actualizar el modelo
de datos. Este fichero <code>upgradeXXX.sql</code> lo colocaremos en el mismo
directorio de inicialización junto con el fichero <code>backup.sql</code> que
contiene los datos y el esquema anterior. El contenedor cargará ambos
ficheros en el orden correcto (primero <code>backup.sql</code> y después
<code>upgradeXXX.sql</code>). </p>
<p>En esta primera versión añadiremos en el fichero <code>upgrade001.sql</code> la
inicialización de la tabla de secuencias de Hibernate, necesaria para
que Hibernate genere las claves primarias de las entidades:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">--</span>
<span class="c1">-- Dumping data for table `hibernate_sequence`</span>
<span class="c1">--</span>

<span class="k">LOCK</span> <span class="n">TABLES</span> <span class="o">`</span><span class="n">hibernate_sequence</span><span class="o">`</span> <span class="k">WRITE</span><span class="p">;</span>
<span class="cm">/*!40000 ALTER TABLE `hibernate_sequence` DISABLE KEYS */</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">hibernate_sequence</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">),(</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*!40000 ALTER TABLE `hibernate_sequence` ENABLE KEYS */</span><span class="p">;</span>
<span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>En las siguientes releases, en cada versión nueva que conlleve una
modificación del esquema de datos, deberemos:</p>
<ol>
<li>Grabar los datos en un fichero <code>backup.sql</code> y parar y borrar el
   contenedor docker.</li>
<li>Colocar ese fichero <code>backup.sql</code> junto con el fichero <code>upgradeXXX.sql</code>
   que contiene los comandos ALTER TABLE necesarios para la nueva
   versión en el mismo directorio.</li>
<li>Volver a arrancar el contenedor docker sobre el directorio en el
   que se encuentran los ficheros <code>backup.sql</code> y <code>upgradeXXX.sql</code>. Los
   datos se volverán a cargar en la base de datos y se ejecutarán los
   comandos de actualización de las tablas.</li>
</ol>
<h3 id="ejecucion-de-la-aplicacion-en-produccion">Ejecución de la aplicación en producción<a class="headerlink" href="#ejecucion-de-la-aplicacion-en-produccion" title="Permanent link">&para;</a></h3>
<p>En la configuración de producción en lugar de dejar que JPA cree las
tablas de la base de datos, vamos nosotros a inicializar la base de
datos MySQL con los esquemas y datos predefinidos. JPA va a validar
que las tablas se corresponden con el esquema de datos. Para ello
podemos usar el siguiente fichero de configuración
<code>conf/production.conf</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>include &quot;application.conf&quot;

play.crypto.secret=&quot;abcdefghijkl&quot;

jpa.default = production

db.default.driver=com.mysql.jdbc.Driver
db.default.url=${?DB_URL}
db.default.username=${?DB_USER_NAME}
db.default.password=${?DB_USER_PASSWD}
</pre></div>
</td></tr></table>

<p>Este fichero define como unidad de persistencia de JPA la unidad
denominada <code>default</code> que está definida en el fichero de configuración
de JPA <code>conf/META-INF/persistence.xml</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>&lt;!-- MySQL Persistence Unit - Production: hbm2ddl.auto = VALIDATE --&gt;

&lt;persistence-unit name=&quot;production&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&gt;
   &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;
   &lt;non-jta-data-source&gt;DBTodoList&lt;/non-jta-data-source&gt;
   &lt;class&gt;models.Usuario&lt;/class&gt;
   &lt;class&gt;models.Tarea&lt;/class&gt;
   &lt;class&gt;models.Equipo&lt;/class&gt;
   &lt;class&gt;models.Admin&lt;/class&gt;
   &lt;class&gt;models.Etiqueta&lt;/class&gt;
   &lt;properties&gt;
      &lt;property name=&quot;hibernate.dialect&quot; value=&quot;org.hibernate.dialect.MySQL5Dialect&quot;/&gt;
      &lt;property name=&quot;hibernate.hbm2ddl.auto&quot; value=&quot;validate&quot;/&gt;
   &lt;/properties&gt;
&lt;/persistence-unit&gt;
</pre></div>
</td></tr></table>

<p>Vemos que en esta configuración el valor de la propiedad
<code>hibernate.hbm2ddl.auto</code> es <code>validate</code>. De esta forma JPA validará que
el esquema de base de datos existente se mapea correctamente con las
entidades definidas.</p>
<p>Para ejecutar la aplicación Play en modo producción lanzamos nuestra
imagen definiendo las variables de entorno para que la configuración
se conecte con la BD y usando el fichero <code>conf/production.conf</code> como
fichero de inicialización.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --link db-mysql --rm -it -p 9000:9000 \
-e DB_URL=&quot;jdbc:mysql://db-mysql:3306/mads&quot; -e DB_USER_NAME=&quot;root&quot; \
-e DB_USER_PASSWD=&quot;mads&quot; -e CONFIG_FILE=&quot;conf/production.conf&quot; &lt;usuario&gt;/mads-todolist-equipo-XX
</pre></div>
</td></tr></table>

<p>El flag <code>-it</code> permite visualizar en el terminal de forma interactiva
la salida estándar de la aplicación Play y terminarla haciendo un <code>CTRL-C</code>.</p>
<!-- 
Añadir fichero 'schema-latest.sql' en el directorio sql con la
última versión del esquema de datos, tal y como expliqué en clase. 
Por ejemplo, el equipo 12 lo ha hecho así.

https://github.com/mads-ua-18/todolistgrupo-2018-equipo-12/pull/18/files
-->

<h3 id="pasos-a-seguir_3">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_3" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Cread un nuevo <em>issue</em> con el título <code>Esquema de datos</code>. El equipo
  escogerá un <strong>responsable de base de datos</strong>, que se encargará de
  este <em>issue</em> abriendo un nuevo PR en <code>develop</code>.</p>
</li>
<li>
<p>Para resolver el <em>issue</em> se deberá obtener el fichero <code>schema.sql</code>
  con el esquema inicial de la aplicación y añadirlo en un nuevo
  directorio <code>sql</code> en la raíz del proyecto Play.</p>
</li>
<li>
<p>Se deberá crear también dentro de ese directorio el fichero
  <code>upgrade001.sql</code> con el contenido necesario para actualizar la tabla de
  secuencias de Hibernate.</p>
</li>
<li>
<p>Lanzad una nueva release <code>1.3.2</code> desde <code>develop</code> y realizad su
  despliegue en producción. Añadid algunos ejemplos de usuarios,
  tareas y equipos en producción. Una vez añadidos, volcad la base de
  datos resultante y guardadla con el nombre de <code>bd-producion-1.sql</code>.</p>
</li>
<li>
<p>Añadid un nuevo <em>issue</em> con el título <code>Prueba actualización bd
  producción</code>. Abrid un PR desde <code>develop</code> y modificad alguna entidad
  (por ejemplo, añadid un atributo de texto <code>direccion</code> al usuario) y
  lanzad una nueva release <code>1.3.3</code> desde <code>develop</code>. </p>
</li>
<li>
<p>En la rama de release el responsable de base de datos deberá
  comprobar el esquema de datos que se genera con los cambios
  introducidos en la nueva release y añadir un nuevo fichero
  <code>upgrade002.sql</code> para que contemple esos cambios.</p>
</li>
<li>
<p>Una vez terminado el release el responsable de despliegue actualizar
  la base de datos de producción con los nuevos cambios. Se deberá
  por último añadir algún dato más y volcar la base de datos
  resultante con el nombre de <code>bd-produccion-2.sql</code>.</p>
</li>
</ul>
<h2 id="entrega-y-evaluacion">Entrega y evaluación<a class="headerlink" href="#entrega-y-evaluacion" title="Permanent link">&para;</a></h2>
<ul>
<li>La práctica tiene una duración de 3 semanas y debe estar terminada
  el martes 20 de noviembre.</li>
<li>La calificación de la práctica tiene un peso de un 5% en la nota
  final de la asignatura.</li>
<li>Para realizar la entrega uno de los miembros del equipo debe subir a
  Moodle un ZIP que contenga todo el proyecto y los ficheros
  <code>bd-produccion-1.sql</code> y <code>bd-produdcción-2.sql</code>. Debes dejar también
  en Moodle la URL del repositorio en GitHub.</li>
</ul>
<p>Para la evaluación se tendrá en cuenta:</p>
<ul>
<li>Desarrollo continuo (los <em>commits</em> deben realizarse a lo largo de
  las 3 semanas y no dejar todo para la última semana).</li>
<li>Correcto desarrollo de la metodología.</li>
<li>Corrección del código.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>