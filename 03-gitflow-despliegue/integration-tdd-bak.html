



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Integration tdd bak - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#practica-2-integracion-con-travis-y-tdd" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Prácticas MADS" class="md-header-nav__button md-logo">
          
            <img src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Prácticas MADS
            </span>
            <span class="md-header-nav__topic">
              Integration tdd bak
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo">
      
        <img src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Práctica 0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Práctica 0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/intro-spring-boot.html" title="Introducción a Sprign Boot para MADS" class="md-nav__link">
      Introducción a Sprign Boot para MADS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/comandos-git.html" title="Comandos Git" class="md-nav__link">
      Comandos Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica0.html" title="Práctica 0" class="md-nav__link">
      Práctica 0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica1.html" title="Práctica 1" class="md-nav__link">
      Práctica 1
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-pruebas-tdd/integration-tdd.html" title="Práctica 2" class="md-nav__link">
      Práctica 2
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#refactorizacion-de-la-relacion-uno-a-muchos" title="Refactorización de la relación uno-a-muchos" class="md-nav__link">
    Refactorización de la relación uno-a-muchos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir-en-la-practica" title="Pasos a seguir en la práctica" class="md-nav__link">
    Pasos a seguir en la práctica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-la-aplicacion" title="Configuración de la aplicación" class="md-nav__link">
    Configuración de la aplicación
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ficheros-de-configuracion-de-la-aplicacion" title="Ficheros de configuración de la aplicación" class="md-nav__link">
    Ficheros de configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir-en-la-practica_1" title="Pasos a seguir en la práctica" class="md-nav__link">
    Pasos a seguir en la práctica
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fichero-de-configuracion-de-jpa" title="Fichero de configuración de JPA" class="md-nav__link">
    Fichero de configuración de JPA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variables-de-entorno" title="Variables de entorno" class="md-nav__link">
    Variables de entorno
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir-en-la-practica_2" title="Pasos a seguir en la práctica" class="md-nav__link">
    Pasos a seguir en la práctica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#construccion-y-publicacion-de-la-imagen-docker" title="Construcción y publicación de la imagen docker" class="md-nav__link">
    Construcción y publicación de la imagen docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alta-en-docker-hub" title="Alta en Docker Hub" class="md-nav__link">
    Alta en Docker Hub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#construccion-de-la-imagen-docker" title="Construcción de la imagen docker" class="md-nav__link">
    Construcción de la imagen docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir-en-la-practica_3" title="Pasos a seguir en la práctica" class="md-nav__link">
    Pasos a seguir en la práctica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integracion-continua-con-travis" title="Integración continua con Travis" class="md-nav__link">
    Integración continua con Travis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conexion-con-github" title="Conexión con GitHub" class="md-nav__link">
    Conexión con GitHub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests-en-los-pull-requests" title="Tests en los pull requests" class="md-nav__link">
    Tests en los pull requests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#el-fichero-de-configuracion" title="El fichero de configuración" class="md-nav__link">
    El fichero de configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#builds-en-travis" title="Builds en Travis" class="md-nav__link">
    Builds en Travis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versiones-en-docker-hub" title="Versiones en Docker Hub" class="md-nav__link">
    Versiones en Docker Hub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir-en-la-practica_4" title="Pasos a seguir en la práctica" class="md-nav__link">
    Pasos a seguir en la práctica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tdd" title="TDD" class="md-nav__link">
    TDD
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#008-listado-de-equipos" title="008 Listado de equipos" class="md-nav__link">
    008 Listado de equipos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir-en-la-practica_5" title="Pasos a seguir en la práctica" class="md-nav__link">
    Pasos a seguir en la práctica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-y-evaluacion" title="Entrega y evaluación" class="md-nav__link">
    Entrega y evaluación
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <!---

Práctica 3:
   - Publicación en DockerHub y Heroku

Más adelante (en la práctica 3) veremos cómo usar la configuración de
producción para ejecutar la práctica en un servicio de hosting.


Práctica 2:


https://github.com/domingogallardo/mads-todolist-inicial/commit/498442afc689e81cc02d5022cfa6a85722a56bc7

- Explicar cómo se añade Travis en la configuración de la organización
  / cuenta personal.

- Diferenciar entre travis.org y travis.com

- Incluir la configuración de base de datos MySQL y lanzar los tests
  con esta base de datos. ¿Cómo lanzar los tests con distintos fichero
  de configuración? ¿Cómo lanzar la aplicación usando un fichero de
  configuración distinto?

Fichero de configuración para trabajar con el perfil MySQL en ejecución:

`src/main/resources/application-mysql.properties`:
wzxhzdk:0

Comando para lanzar el perfil en modo run:

wzxhzdk:1

Fichero de configuración para trabajar con el perfil MySQL en test:

`src/test/resources/application-mysql.properties`:
wzxhzdk:2

Y para lanzar los tests:

wzxhzdk:3


Comando para lanzar la base de datos MySQL:

wzxhzdk:4

Comando para modificar los valores de las propiedades:

wzxhzdk:5

Podmeos añadir propiedades más cortas e inicializar esas:

Fichero `application-prod.properties`:

wzxhzdk:6

- Para lanzar mysql docker con usuario root sin password en el puerto 3306:

wzxhzdk:7

- Travis deberá lanzar los tests unitarios usando MySQL


### Maven Wrapper ###


Maven Wrapper: https://www.baeldung.com/maven-wrapper

Para instalar Maven Wrapper:

wzxhzdk:8

Para ejecutar la aplicación con Maven Wrapper:

wzxhzdk:9

## Para la práctica 3 ##

### Dockerizar la aplicación ###



https://spring.io/guides/gs/spring-boot-docker/

### Docker compose ###

https://medium.com/@chrischuck35/how-to-create-a-mysql-instance-with-docker-compose-1598f3cc1bee
https://docs.docker.com/compose/

-->

<h1 id="practica-2-integracion-con-travis-y-tdd">Práctica 2: Integración con Travis y TDD<a class="headerlink" href="#practica-2-integracion-con-travis-y-tdd" title="Permanent link">&para;</a></h1>
<p>En esta práctica 2 de la asignatura realizaremos dos tareas principales:</p>
<ul>
<li>Configuraremos un sistema de integración continua conectando el
  repositorio de GitHub con Travis. En este sistema se lanzarán los
  tests automáticamente en cada <em>pull request</em> sobre la base de datos
  MySQL.</li>
<li>Añadiremos nuevas funcionalidades usando la práctica XP de TDD
  (<em>Test Driven Design</em>).</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Lee con cuidado todo el enunciado y dedica especial atención a los
apartados con el título <code>Pasos a seguir en la práctica</code>. Ahí están
especificadas las acciones que debes realizar en la práctica.</p>
</div>
<p>La duración de la práctica es de 2 semanas y la fecha límita de
entrega es el día 30 de octubre.</p>
<h2 id="refactorizacion-de-la-relacion-uno-a-muchos">Refactorización de la relación uno-a-muchos<a class="headerlink" href="#refactorizacion-de-la-relacion-uno-a-muchos" title="Permanent link">&para;</a></h2>
<p>Antes de comenzar la práctica hay que hacer una refactorización en la
relación una-a-muchos entre usuario y tareas: pasar la lista de tareas
de un usuario de <code>List</code> a <code>Set</code>. </p>
<p>A diferencias del tipo <code>List</code>, el <code>Set</code> no permite elementos repetidos
y es más conveniente definir las relaciones JPA de esta forma.</p>
<h3 id="pasos-a-seguir-en-la-practica">Pasos a seguir en la práctica<a class="headerlink" href="#pasos-a-seguir-en-la-practica" title="Permanent link">&para;</a></h3>
<ul>
<li>Realiza un commit en <code>master</code> (no hace falta que hagas un pull
  request) con los cambios que aparecen este <a href="https://github.com/domingogallardo/mads-todolist-inicial/commit/498442afc689e81cc02d5022cfa6a85722a56bc7">commit</a>.</li>
<li>Lanza los tests para comprobar que todo funciona correctamente y
  sube el commit a GitHub.</li>
</ul>
<h2 id="configuracion-de-la-aplicacion">Configuración de la aplicación<a class="headerlink" href="#configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h2>
<p>Hasta ahora hemos trabajado con la aplicación en una configuración
local con nuestro ordenador de desarrollo trabajando sobre una base de
datos H2 en memoria. Pero el objetivo final es poner la aplicación en
producción, en un servidor en Internet y usando una base de datos
MySQL de producción. </p>
<p>En esta práctica vamos a configurar un perfil de la aplicación para
poder lanzar los tests y ejecutar la aplicación usando una base de
datos MySQL. En la práctica 3 veremos cómo definir un perfil para
trabajar con una base de datos de producción.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>La <strong>base de datos de producción</strong> es la que mantiene los datos
introducidos por los usuarios de la misma. Hay que prestar una
atención especial a esta base de datos y definir políticas de
respaldo y de control de cambios para evitar que se produzca
cualquier pérdida de información. Veremos en la práctica 3 que una
de las cuestiones que hay que asegurar es que la aplicación no
puede modificar el esquema de datos de esta base de datos. Habrá
que definir un flujo de trabajo para implementar en el esquema de
datos de la base de datos un cambio en el modelo de datos de la
aplicación.</p>
</div>
<p>Vamos a ver en este apartado cómo definir distintas configuraciones de
ejecución de la aplicación, utilizando los denominados
<em>perfiles</em>. Definiremos, además del perfil base, un perfil adicional
para lanzar la aplicación y los tests usando la base de datos MySQL.</p>
<p>La configuración de tests con base de datos MySQL la utilizaremos para
ejecutar los tests de integración en el proceso de integración
continua de Travis.</p>
<h3 id="ficheros-de-configuracion-de-la-aplicacion">Ficheros de configuración de la aplicación<a class="headerlink" href="#ficheros-de-configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>Ya hemos comentado que la configuración de la aplicación se define en
el fichero <code>application.properties</code>. Ahí se definen distintas
propiedades de la ejecución de la aplicación que se pueden modificar
(puerto en el que se lanza la aplicación, base de datos con la que
conectarse, etc.). </p>
<p>Tenemos dos ficheros <code>application.properties</code>: uno en el directorio
<code>src/main/resources</code> que define la configuración de ejecución y otro
en el directorio <code>src/test/resources</code> que define la configuración que
se carga cuando se lanzan los tests.</p>
<p>Spring Boot permite definir ficheros de configuración adicionales que
pueden sobreescribir las propiedades definidas en el fichero de
configuración por defecto. El nombre de estos ficheros de
configuración debe ser <code>application-xxx.profile</code> donde <code>xxx</code> define el
nombre del perfil. En nuestro caso definiremos los ficheros
<code>application-mysql.profile</code> (uno en el directorio <code>main</code> y otro en
<code>test</code>) para definir las configuraciones de ejecución y de test con
MySQL.</p>
<h3 id="pasos-a-seguir-en-la-practica_1">Pasos a seguir en la práctica<a class="headerlink" href="#pasos-a-seguir-en-la-practica_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Instala <a href="https://www.docker.com/products/docker-desktop">Docker
  Desktop</a>. </li>
</ul>
<p>Docker es un software de virtualización que utiliza el propio
  sistema operativo compartimentado y permite gestionar <em>contenedores</em>
  (similares a las máquinas virtuales) de forma mucho menos pesada y
  rápida que con sistemas de virtualización tradicionales como
  VirtualBox.</p>
<p>Lo vamos a utilizar para <strong>lanzar el servidor MySQL de base de
  datos</strong> y también para la futura práctica 3.</p>
<p>Si tienes Windows, Docker no es compatible con VirtualBox. Si
  quieres usar ambos programas puedes usar una versión limitada de
  Docker llamada <a href="https://docs.docker.com/toolbox/toolbox_install_windows/">Docker
  Toolbox</a></p>
<ul>
<li>
<p>Crea un nuevo <em>issue</em> llamado <code>Añadir perfiles y permitir trabajar
  con MySQL</code>. Crea una rama nueva y haz los siguientes cambios en ella.</p>
</li>
<li>
<p>Copia el siguiente fichero en <code>src/main/resources/application-mysql.properties</code>:</p>
</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>spring.datasource.url=jdbc:mysql://localhost:3306/mads
spring.datasource.username=root
spring.datasource.password=
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5Dialect
spring.jpa.hibernate.ddl-auto=update
spring.datasource.initialization-mode=never
</pre></div>
</td></tr></table>

<p>En este fichero de configuración se define la URL de conexión a la
   base de datos MySQL, su usuario (<code>root</code>) y contraseña (vacía) y el
   dialecto que se va a utilizar para trabajar desde JPA con la base
   de datos (<code>org.hibernate.dialect.MySQL5Dialect</code>). Además se indica
   que no se debe cargar ningún fichero de datos inicial. El esquema
   de la base de datos se actualizará si hay cambios en las entidades
   de la aplicación, y los datos se mantendrán en la base de datos.</p>
<ul>
<li>Copia el siguiente fichero en <code>src/test/resources/application-mysql.properties</code>:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>spring.datasource.url=jdbc:mysql://localhost:3306/mads
spring.datasource.username=root
spring.datasource.password=
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5Dialect
spring.jpa.hibernate.ddl-auto=create
</pre></div>
</td></tr></table>

<p>La diferencia más importante es el valor de
   <code>spring.jpa.hibernate.ddl-auto</code>, que es <code>create</code>. De esta forma la
   base de datos se inicializa antes de cargar los datos de los tests
   y de ejecutarlos.</p>
<ul>
<li>Añade la siguiente dependencia en el fichero <code>pom.xml</code> para que se
  descargue el driver <code>mysql-connector-java</code> y poder utilizar una base
  de datos MySQL en la aplicación:</li>
</ul>
<p><strong>Fichero <code>pom.xml</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>            &lt;artifactId&gt;h2&lt;/artifactId&gt;
             &lt;scope&gt;runtime&lt;/scope&gt;
         &lt;/dependency&gt;
<span class="gi">+         &lt;dependency&gt;</span>
<span class="gi">+             &lt;groupId&gt;mysql&lt;/groupId&gt;</span>
<span class="gi">+             &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span>
<span class="gi">+         &lt;/dependency&gt;</span>
         &lt;dependency&gt;
             &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</pre></div>
</td></tr></table>

<ul>
<li>
<p>Para lanzar la aplicación necesitarás un servidor MySQL en el puerto
  3306 con el usuario <code>root</code> sin contraseña. Es muy sencillo
  descargarlo y ejecutarlo si tienes instalado Docker. Ejecuta desde
  el terminal:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -d -p <span class="m">3306</span>:3306 -e <span class="nv">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class="o">=</span>yes -e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>mads mysql:5
</pre></div>
</td></tr></table>

</li>
</ul>
<p>Docker se descarga la imagen <code>mysql:5</code> y lanza el contenedor (una
   instancia en marcha de una imagen) conectado al puerto 3306 y sobre
   la base de datos <code>mads</code>. </p>
<p>Puedes ejecutar los siguientes comandos de docker:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>```
$ docker container ls -a (comprueba todos los contenedores en marcha)
$ docker container stop &amp;lt;nombre o id de contenedor&amp;gt; (para un contenedor)
$ docker container rm &amp;lt;nombre o id de contenedor&amp;gt; (elimina un contenedor)
```
</pre></div>
</td></tr></table>

<ul>
<li>Arranca la aplicación con el siguiente comando:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ mvn spring-boot:run -Dspring-boot.run.profiles<span class="o">=</span>mysql
 <span class="sb">```</span>

   Se cargarán las preferencias de <span class="sb">`</span>src/main/resource/application.profile<span class="sb">`</span> y
   <span class="sb">`</span>src/main/resource/application-mysql.profile<span class="sb">`</span>.

   Prueba a introducir datos en la aplicación y comprueba que se están
   guardando en la base de datos con <span class="sb">`</span>MySQL Workbench<span class="sb">`</span> o alguna
   aplicación similar.


&lt;img <span class="nv">src</span><span class="o">=</span><span class="s2">&quot;images/mysql-workbench.png&quot;</span> <span class="nv">width</span><span class="o">=</span><span class="s2">&quot;600px&quot;</span>/&gt;






La propiedad Java <span class="sb">`</span>config.file<span class="sb">`</span> permite definir un fichero de
configuración distinto del de por defecto. Se puede configurar en las
<span class="sb">`</span>javaOptions<span class="sb">`</span> de <span class="sb">`</span>sbt<span class="sb">`</span>:

<span class="sb">```</span>text
<span class="o">[</span>mads-todolist-dgallardo<span class="o">]</span> $ <span class="nb">set</span> <span class="nv">javaOptions</span> <span class="o">+=</span> <span class="s2">&quot;-Dconf.file=conf/&lt;FICHERO-CONF&gt;.conf&quot;</span>
</pre></div>
</td></tr></table>

<p>Vamos a utilizar dos ficheros de configuración distintos:</p>
<ul>
<li>Fichero <code>conf/develop-mysql.conf</code>: para lanzar las pruebas de integración.</li>
<li>Fichero <code>conf/production.conf</code>: para ejecutar la aplicación en producción.</li>
</ul>
<p><strong>Fichero <code>conf/develop-mysql.conf</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>include &quot;application.conf&quot;

db.default.driver=com.mysql.jdbc.Driver
db.default.url=${?DB_URL}
db.default.username=${?DB_USER_NAME}
db.default.password=${?DB_USER_PASSWD}
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>conf/production.conf</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>include &quot;application.conf&quot;

play.crypto.secret=&quot;abcdefghijkl&quot;

jpa.default = production

db.default.driver=com.mysql.jdbc.Driver
db.default.url=${?DB_URL}
db.default.username=${?DB_USER_NAME}
db.default.password=${?DB_USER_PASSWD}
</pre></div>
</td></tr></table>

<p>Ambos ficheros incluyen el fichero <code>application.conf</code> en el que se
definen las siguientes propiedades relacionadas con la base de datos:</p>
<p><strong>Fichero `conf/application.conf</strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># Default persistenceUnit for JPA
jpa.default = develop

db {
  # You can declare as many datasources as you want.
  # By convention, the default datasource is named `default`

  # https://www.playframework.com/documentation/latest/Developing-with-the-H2-Database
  # Memory H2 database
  default.driver = org.h2.Driver
  default.url = &quot;jdbc:h2:mem:play;MODE=MYSQL&quot;
  #default.username = sa
  #default.password = &quot;&quot;
  # Definimos el nombre JNDI de la BD que va a usar la aplicación
  default.jndiName=DBTodoList

  # You can turn on SQL logging for any datasource
  # https://www.playframework.com/documentation/latest/Highlights25#Logging-SQL-statements
  # default.logSql=true
}
</pre></div>
</td></tr></table>

<h3 id="fichero-de-configuracion-de-jpa">Fichero de configuración de JPA<a class="headerlink" href="#fichero-de-configuracion-de-jpa" title="Permanent link">&para;</a></h3>
<p>Vemos en los ficheros anteriores que la diferencia fundamental es el valor de la
propiedad <code>jpa.default</code>. En esta propiedad se define el nombre de la
unidad de persistencia que se va a usar en JPA. Las unidades de
persistencia están definidas en el fichero
<code>conf/META-INF/persistence.xml</code>.</p>
<p><strong>Fichero `conf/META-INF/persistence.xml</strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c">&lt;!-- MySQL Persistence Unit - Develop: hbm2ddl.auto = UPDATE --&gt;</span>

<span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;develop&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;RESOURCE_LOCAL&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="nt">&lt;/provider&gt;</span>
   <span class="nt">&lt;non-jta-data-source&gt;</span>DBTodoList<span class="nt">&lt;/non-jta-data-source&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Usuario<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Tarea<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Equipo<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Admin<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.dialect&quot;</span> <span class="na">value=</span><span class="s">&quot;org.hibernate.dialect.MySQL5Dialect&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;update&quot;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;/persistence-unit&gt;</span>

<span class="c">&lt;!-- MySQL Persistence Unit - Production: hbm2ddl.auto = VALIDATE --&gt;</span>

<span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;production&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;RESOURCE_LOCAL&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="nt">&lt;/provider&gt;</span>
   <span class="nt">&lt;non-jta-data-source&gt;</span>DBTodoList<span class="nt">&lt;/non-jta-data-source&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Usuario<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Tarea<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Equipo<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Admin<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;properties&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.dialect&quot;</span> <span class="na">value=</span><span class="s">&quot;org.hibernate.dialect.MySQL5Dialect&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;validate&quot;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;/persistence-unit&gt;</span>
</pre></div>
</td></tr></table>

<p>La diferencia fundamental entre ambas unidades de persistencia es el
valor de la propiedad <code>hibernate.hbm2ddl.auto</code>, que define cómo
gestiona JPA el mapeo entre las entidades Java y las tablas físicas de
la base de datos.</p>
<p>En la unidad de persistencia <code>develop</code> hemos usado el valor
<code>update</code>. Esto significa que JPA actualizará la base de datos,
modificando su esquema, para hacerlo corresponder con las entidades
definidas en la aplicación. Si en alguna entidad añadimos algún
atributo, el esquema de la base de datos se actualizará, añadiendo un
campo en la tabla correspondiente.</p>
<p>En la unidad de persistencia <code>production</code> hemos usado el valor
<code>validate</code>. En este caso JPA comprobará si el esquema de la base de
datos se corresponde con las entidades de la aplicación. Si no es así,
se lanzará una excepción y JPA dejará de funcionar.</p>
<p>El primer valor es muy útil para el realizar el desarrollo y los tests
de integración de la aplicación. Pero no se debe usar en producción
porque no queremos que la base de datos de producción (donde están
todos los datos introducidos por los usuarios finales) se modifique
tan fácilmente. Cualquier modificación de la base de datos de
producción debe realizarse mediante un proceso que garantice la
posibilidad de la vuelta atrás y la recuperación de posibles errores
que se puedan cometer.</p>
<h3 id="variables-de-entorno">Variables de entorno<a class="headerlink" href="#variables-de-entorno" title="Permanent link">&para;</a></h3>
<p>En ambos ficheros se usan variables de entorno para definir los
valores de la URL de la conexión a la base de datos y el usuario y
contraseña de esa conexión.</p>
<p>Los valores de esas variables se pueden definir de dos formas para
que sean visibles dentro de <code>sbt</code>:</p>
<ul>
<li>
<p>En el shell en el que se lanza el comando <code>sbt</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ <span class="nb">export</span> <span class="nv">DB_URL</span><span class="o">=</span><span class="s2">&quot;jdbc:mysql://localhost:3316/mads&quot;</span>
$ <span class="nb">export</span> <span class="nv">DB_USER_NAME</span><span class="o">=</span>root
$ <span class="nb">export</span> <span class="nv">DB_USER_PASSWD</span><span class="o">=</span>mads
$ sbt <span class="s1">&#39;; set javaOptions += \&quot;-Dconfig.file=conf/develop-mysql.conf\&quot;; test&#39;</span>
</pre></div>
</td></tr></table>

<p>En la última línea vemos cómo es posible lanzar <code>sbt</code> junto con
unos comandos que se lanzarán dentro del propio <code>sbt</code>.</p>
</li>
<li>
<p>Desde dentro del propio <code>sbt</code> con <code>set javaOptions</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[mads-todolist-dgallardo] $ set javaOptions += &quot;-Dconfig.file=conf/develop-mysql.conf&quot;
[mads-todolist-dgallardo] $ set javaOptions += &quot;-DDB_URL=jdbc:mysql://localhost:3316/mads&quot;
[mads-todolist-dgallardo] $ set javaOptions += &quot;-DDB_USER_NAME=root&quot;
[mads-todolist-dgallardo] $ set javaOptions += &quot;-DDB_USER_PASSWD=mads&quot;
[mads-todolist-dgallardo] $ test
</pre></div>
</td></tr></table>

</li>
</ul>
<h3 id="pasos-a-seguir-en-la-practica_2">Pasos a seguir en la práctica<a class="headerlink" href="#pasos-a-seguir-en-la-practica_2" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Ejecuta los tests de la práctica usando el fichero de
configuración <code>develop-mysql.conf</code> para que los realice usando la base
de datos MySQL (que deberás tener activa).</p>
</li>
<li>
<p>Captura la pantalla en la que aparezca el resultado de los tests y el
nombre de la base de datos <code>MySQL</code>. Por ejemplo, si ejecutas <code>sbt</code>
desde IntelliJ, la pantalla resultante deberá ser como la siguiente:</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/02-pruebas-tdd/imagenes/salida-test-mysql.png" width="500px"/></p>
<h2 id="construccion-y-publicacion-de-la-imagen-docker">Construcción y publicación de la imagen docker<a class="headerlink" href="#construccion-y-publicacion-de-la-imagen-docker" title="Permanent link">&para;</a></h2>
<p>Para facilitar la ejecución de la aplicación en diferentes entornos,
vamos a generar y publicar una imagen docker de la misma.</p>
<h3 id="alta-en-docker-hub">Alta en Docker Hub<a class="headerlink" href="#alta-en-docker-hub" title="Permanent link">&para;</a></h3>
<p>Crea una cuenta en <a href="https://hub.docker.com">docker hub</a>. La utilizarás
para subir allí, utilizando tu <em>Docker ID</em>, la image docker de tu
práctica.</p>
<h3 id="construccion-de-la-imagen-docker">Construcción de la imagen docker<a class="headerlink" href="#construccion-de-la-imagen-docker" title="Permanent link">&para;</a></h3>
<p>Empezamos construyendo la imagen docker en local y comprobando que
funciona correctamente.</p>
<h4>Comando <code>stage</code> de <code>sbt</code></h4>
<p>El comando <code>stage</code> de <code>sbt</code> genera un comando ejecutable con el que se puede
lanzar la aplicación sin usar <code>sbt</code>. Genera un script con el nombre de
la aplicación en el directorio <code>target/universal/stage/bin</code>. Genera
también un fichero <code>bat</code> para Windows.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[mads-todolist-dgallardo] $ stage
</pre></div>
</td></tr></table>

<p>El script generado lanza la aplicación en modo producción. En este modo es
necesario definir la variable <code>play.crypto.key</code> con una cadena inicial.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ target/universal/stage/bin/mads-todolist-dgallardo -Dplay.crypto.secret<span class="o">=</span>abcdefghijk
</pre></div>
</td></tr></table>

<p>Al lanzar el comando generado por <code>sbt stage</code> es posible definir el
fichero de configuración que va a usar la ejecución de la
aplicación. Esta va a ser la característica clave que nos va a
permitir usar distintas configuraciones.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ target/universal/stage/bin/mads-todolist-dgallardo -Dconfig.file<span class="o">=</span>conf/&lt;FICHERO-CONF&gt;.conf
</pre></div>
</td></tr></table>

<h4>Fichero Dockerfile</h4>
<p>El fichero <code>Dockerfile</code> es el fichero en el que se definen las
instrucciones para construir la imagen. Docker lo ejecuta paso a
paso para ir creando una imagen de una máquina virtual con los
elementos necesarios para ejecutar nuestra aplicación.</p>
<p>Debemos colocar el fichero <code>Dockerfile</code> en la raíz del proyecto.</p>
<p><strong>Fichero <code>Dockerfile</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> domingogallardo/playframework</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
COPY . /app
<span class="k">RUN</span> sbt clean stage

<span class="k">EXPOSE</span><span class="s"> 9000</span>
<span class="k">ENV</span><span class="s"> CONFIG_FILE=conf/application.conf</span>
<span class="k">ENV</span><span class="s"> SECRET=abcdefghijk</span>

<span class="k">CMD</span><span class="s"> target/universal/stage/bin/mads-todolist-2017 -Dplay.crypto.secret=$SECRET -Dconfig.file=$CONFIG_FILE</span>
</pre></div>
</td></tr></table>

<p>Algunos puntos a destacar:</p>
<ul>
<li>La línea <code>FROM</code> indica la imagen docker base sobre la que se construye
la aplicación.</li>
<li>La línea <code>WORKDIR</code> indica el directorio en el que se van a ejecutar
todos los comandos <code>COPY</code>, <code>RUN</code> o <code>CMD</code>. Si el directorio no existe en
la imagen, se crea. En este caso creamos el directorio <code>/app</code> en el
que se va a compilar la aplicación.</li>
<li>El comando <code>COPY</code> copia el directorio actual (y sus subdirectorios) en
el directorio <code>/app</code> de la máquina Docker. De esta forma copiamos
el fuente de la aplicación Play.</li>
<li>El comando <code>RUN</code> ejecuta lo que hay a continuación dentro de la
máquina virtual en el proceso de construcción de la imagen. En este
caso se lanza <code>sbt clean stage</code> para compilar el proyecto y generar el
ejecutable (que se guardará en el directorio
<code>target/universal/stage/bin/NOMBRE_PROYECTO</code>).</li>
<li>Los siguientes comandos ya son para cuando se ejecuta el
contenedor. El comando <code>EXPOSE</code> define un puerto a mapear con la
máquina host. En este caso el puerto 9000, que es en el que se lanza
la aplicación. El comando <code>ENV</code> define valores por defecto de
variables de entorno. Estas variables pueden ser sobreescritas con el
parámetro <code>-e</code> en un <code>docker run</code>. En nuestro caso definimos el
fichero de configuración por defecto y la palabra <code>SECRET</code> por
defecto.</li>
<li>Por último, <code>CMD</code> define el comando que se ejecuta en el contenedor
cuando se realiza un <code>docker run</code>. En nuestro caso llamamos a la
aplicación pasando como parámetro el fichero de configuración y la
palabra <code>SECRET</code>.</li>
</ul>
<h4>Comando <code>docker build</code></h4>
<p>Una vez creado el fichero <code>Dockerfile</code> ya podemos hacer un
<code>docker build</code> para construir la imagen con nuestra aplicación. Como nombre de la imagen usaremos
<code>&lt;usuario-docker&gt;/mads-todolist:1.1.0</code>. Docker identifica el número que
hay después de los dos puntos como el número de versión.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ <span class="nb">cd</span> mads-todolist-guia
$ docker build -t &lt;DOCKER-ID&gt;/mads-todolist:1.1.0 .
</pre></div>
</td></tr></table>

<h4>Ejecución de la imagen docker</h4>
<p>Una vez construida la imagen es posible usarla para ejecutar la
aplicación de muchas maneras. En todas ellas se lanzará la imagen
usando el comando <code>docker run</code>. </p>
<p>Lo más sencillo es ejecutar la aplicación trabajando con la base de
datos en memoria:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -it --rm -p <span class="m">9000</span>:9000 domingogallardo/mads-todolist:1.1.0
</pre></div>
</td></tr></table>

<p>El flag <code>-it</code> permite visualizar en el terminal de forma interactiva
la salida estándar de la aplicación Play y terminarla haciendo un <code>CTRL-C</code>.</p>
<p>También podemos lanzar la aplicación para que trabaje con MySQL,
definiendo las variables de entorno necesarias.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --link db-mysql --rm -it -p <span class="m">9000</span>:9000 <span class="se">\</span>
-e <span class="nv">DB_URL</span><span class="o">=</span><span class="s2">&quot;jdbc:mysql://db-mysql:3306/mads&quot;</span> -e <span class="nv">DB_USER_NAME</span><span class="o">=</span><span class="s2">&quot;root&quot;</span> <span class="se">\</span>
-e <span class="nv">DB_USER_PASSWD</span><span class="o">=</span><span class="s2">&quot;mads&quot;</span> -e <span class="nv">CONFIG_FILE</span><span class="o">=</span><span class="s2">&quot;conf/develop-mysql.conf&quot;</span> domingogallardo/mads-todolist:1.1.0
</pre></div>
</td></tr></table>

<p>El comando se conecta con el contenedor <code>db-mysql</code> en el que hemos
lanzado la base de datos MySQL:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -d -p <span class="m">3316</span>:3306 --name db-mysql -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>mads -e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>mads mysql:5
</pre></div>
</td></tr></table>

<p>Si en algún momento nos encontramos con un error podemos ver el log
del contenedor (si estamos depurando es convieniente lanzar la aplicación sin el flag
<code>--rm</code> para poder examinar el contenedor):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container ls -a
CONTAINER ID        IMAGE                                STATUS              PORTS                               NAMES
19986a063c03        domingogallardo/mads-todolist:1.1.0  Up <span class="m">2</span> minutes        <span class="m">0</span>.0.0.0:9000-&gt;9000/tcp              zen_payne
$ docker container logs 19986a063c03
<span class="o">[</span>info<span class="o">]</span> application - Creating Pool <span class="k">for</span> datasource <span class="s1">&#39;default&#39;</span>
<span class="o">[</span>info<span class="o">]</span> p.a.d.HikariCPConnectionPool - datasource <span class="o">[</span>default<span class="o">]</span> bound to JNDI as DBTodoList
<span class="o">[</span>info<span class="o">]</span> p.a.d.DefaultDBApi - Database <span class="o">[</span>default<span class="o">]</span> connected at jdbc:mysql://db-mysql:3306/mads
<span class="o">[</span>info<span class="o">]</span> application - ApplicationTimer demo: Starting application at <span class="m">2018</span>-10-06T11:57:24.119Z
<span class="o">[</span>info<span class="o">]</span> play.api.Play - Application started <span class="o">(</span>Prod<span class="o">)</span>
<span class="o">[</span>info<span class="o">]</span> p.c.s.NettyServer - Listening <span class="k">for</span> HTTP on /0.0.0.0:9000
</pre></div>
</td></tr></table>

<h4>Lanzamiento de tests</h4>
<p>Podemos también ejecutar los tests haciendo que el contenedor ejecute el comando
<code>bash</code> con <code>sbt test</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --rm domingogallardo/mads-todolist:1.1.0 /bin/bash -c <span class="s2">&quot;sbt test&quot;</span>
</pre></div>
</td></tr></table>

<p>Para los tests de integración con la base de datos real MySQL:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --link db-mysql --rm -e <span class="nv">DB_URL</span><span class="o">=</span><span class="s2">&quot;jdbc:mysql://db-mysql:3306/mads&quot;</span> <span class="se">\</span>
     -e <span class="nv">DB_USER_NAME</span><span class="o">=</span><span class="s2">&quot;root&quot;</span> -e <span class="nv">DB_USER_PASSWD</span><span class="o">=</span><span class="s2">&quot;mads&quot;</span> domingogallardo/mads-todolist:1.1.0 <span class="se">\</span>
     /bin/bash -c <span class="s2">&quot;sbt &#39;; set javaOptions += \&quot;-Dconfig.file=conf/develop-mysql.conf\&quot;; test&#39;&quot;</span>
</pre></div>
</td></tr></table>

<h4>Subida a docker hub</h4>
<p>Una vez construida la imagen se puede subir a Docker Hub haciendo
<code>docker push</code> (después de autenticarse con <code>docker login</code>). Tardará
bastante la primera vez. En las siguientes compilaciones ya no tardará
tanto, porque sólo se subirá la parte que cambia de la máquina.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker login
Username: &lt;docker-id&gt;
Password: &lt;contraseña&gt;
$ docker push domingogallardo/mads-todolist:1.1.0
</pre></div>
</td></tr></table>

<p>Allí estará disponible para descargarla y ejecutarla desde cualquier servidor.</p>
<h4>La etiqueta latest</h4>
<p>Utilizando la etiqueta <code>latest</code> marcamos una imagen como la imagen por
defecto que se descarga si no se proporciona un número de versión.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker image ls
REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE
domingogallardo/mads-todolist   <span class="m">1</span>.1.0               b80593e5f646        <span class="m">31</span> hours ago        734MB
$ docker tag b80593e5f646 domingogallardo/mads-todolist:latest
$ docker push domingogallardo/mads-todolist:latest
</pre></div>
</td></tr></table>

<p>Una vez subida esta imagen es la que se descargará si se hace un <code>pull</code> del repositorio <code>domingogallardo/mads-todolist</code></p>
<h3 id="pasos-a-seguir-en-la-practica_3">Pasos a seguir en la práctica<a class="headerlink" href="#pasos-a-seguir-en-la-practica_3" title="Permanent link">&para;</a></h3>
<ul>
<li>Crea un nuevo <em>issue</em> llamado <code>Integración continua con Travis</code>,
  crea una nueva rama <code>integracion-continua</code> y súbela a GitHub.</li>
<li>Realiza un commit con el fichero <code>Dockerfile</code> añadido.</li>
<li>Construye la máquina docker con tu práctica, prueba que funciona
  bien la ejecución en memoria y el lanzamiento de los tests contra la
  base de datos MySQL (tests de integración) y súbela a Docker
  Hub, con la versión <code>1.1.0</code> y la versión <code>latest</code>.</li>
<li>Comparte en el foro de la asignatura el nombre de tu máquina y el
  enlace a tu página de Docker Hub.</li>
</ul>
<h2 id="integracion-continua-con-travis">Integración continua con Travis<a class="headerlink" href="#integracion-continua-con-travis" title="Permanent link">&para;</a></h2>
<p><a href="https://travis-ci.com/">Travis-ci.com</a> es un servicio que permite realizar
integración continua on-line, sin necesidad de configurar un servidor
propio de integración continua.</p>
<p>Es un servicio de pago, pero es gratuito para los repositorios
abiertos (<em>open source</em>) y para las cuentas educativas de GitHub. La
organización de GitHub <code>mads-ua-18</code> también está autorizada como
organización educativa, por lo que todos los repositorios creados
dentro de esa organización podrán trabajar con Travis.</p>
<p>Puedes consultar el funcionamiento de Travis leyendo su documentación,
comenzando por la página <a href="https://docs.travis-ci.com/user/getting-started/">Getting
started</a>.</p>
<p>En la práctica vamos a configurar Travis para que todos los <em>pull
requests</em> deban pasar los tests de integración (conectándose a la base
de datos MySQL) y para que cuando se realice el <em>merge</em> con <code>master</code>
se suba una nueva versión de la máquina docker con la aplicación a
Docker Hub.</p>
<h3 id="conexion-con-github">Conexión con GitHub<a class="headerlink" href="#conexion-con-github" title="Permanent link">&para;</a></h3>
<p>En GitHub está configurada la conexión con Travis para todos los
proyectos en la organización <code>mads-u-18</code>. </p>
<p>En tu cuenta de Travis, una vez logeado, podrás sincronizar tu
repositorio y configurar la conexión. Verás una pantalla como la
siguiente:</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/02-pruebas-tdd/imagenes/conexion-travis.png" width="700px"/></p>
<h3 id="tests-en-los-pull-requests">Tests en los pull requests<a class="headerlink" href="#tests-en-los-pull-requests" title="Permanent link">&para;</a></h3>
<p>Usando Travis es posible configurar el repositorio de GitHub para que todos los
<em>pull requests</em> deban pasar los tests de integración en el servicio.</p>
<p>En la siguiente imagen vemos el aspecto en GitHub de un <em>pull request</em>
estando activa la integración con Travis. Una vez abierto el PR,
Travis comprueba si la integración de master con la rama pasa los
tests definidos en el fichero de configuración. Sólo si los tests
pasan es posible realizar el <em>merge</em> del PR en master.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/02-pruebas-tdd/imagenes/pull-request-travis.png" width="600px"/></p>
<h3 id="el-fichero-de-configuracion">El fichero de configuración<a class="headerlink" href="#el-fichero-de-configuracion" title="Permanent link">&para;</a></h3>
<p>La configuración de Travis se realiza con el fichero <code>.travis.yml</code> en
la raíz del repositorio.</p>
<p>El fichero <code>.travis.yml</code> para mi repositorio solución de la práctica
es el siguiente:</p>
<p><strong>Fichero <code>.travis.yml</code></strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo: required

language: bash

branches:
  only:
  - master

services:
- docker

before_script:
- docker build -t domingogallardo/mads-todolist:$TRAVIS_BUILD_NUMBER .

script:
- docker run -d --rm -p 3306:3306 --name db-mysql -e MYSQL_ROOT_PASSWORD=mads -e MYSQL_DATABASE=mads mysql:5
- docker run --link db-mysql --rm -e DB_URL=&quot;jdbc:mysql://db-mysql:3306/mads&quot; -e DB_USER_NAME=&quot;root&quot; -e DB_USER_PASSWD=&quot;mads&quot; domingogallardo/mads-todolist:$TRAVIS_BUILD_NUMBER /bin/bash -c &quot;sbt &#39;; set javaOptions += \&quot;-Dconfig.file=conf/develop-mysql.conf\&quot;; test&#39;&quot;

after_success:
- if [ &quot;$TRAVIS_EVENT_TYPE&quot; != &quot;pull_request&quot; ]; then
  docker login -u=&quot;$DOCKER_USERNAME&quot; -p=&quot;$DOCKER_PASSWORD&quot;;
  docker push domingogallardo/mads-todolist:$TRAVIS_BUILD_NUMBER;
  docker tag domingogallardo/mads-todolist:$TRAVIS_BUILD_NUMBER domingogallardo/mads-todolist:latest;
  docker push domingogallardo/mads-todolist:latest;
  fi
</pre></div>
</td></tr></table>

<p>Puntos interesantes a destacar:</p>
<ul>
<li>Se puede espeficar la rama en la que se activa la integración
  continua en el apartado <code>branches</code>. En nuestro caso es la rama
  <code>master</code>. En cualquier commit o <em>pull request</em> que se haga sobre esa
  rama se lanzará la integración continua.</li>
<li>El apartado <code>services</code> define los servicios necesarios para que se
  ejecute el script de integración. En nuestro caso <code>docker</code>.</li>
<li>En el apartado <code>before_script</code> se definen los comandos a realizar
  antes de ejecutar el <em>script</em> con los tests. En nuestro caso
  construimos la imagen docker.</li>
<li>En el apartado <code>script</code> se definen los comandos a realizar para
  lanzar los tests. En nuestro caso ponemos en marcha el servicio
  docker de MySQL y lanzamos la máquina docker de la aplicación para
  que ejecute los tests usando la conexión con ese servicio.</li>
<li>Por último, el apartado <code>after_success</code> se ejecuta si los tests han
  pasado correctamente. En nuestro caso definimos la condición
  adicional de que la ejecución de Travis se haya lanzado no por un
  <em>pull request</em> abierto sino porque se ha hecho un <em>merge</em> del <em>pull
  request</em> en master. En ese caso se sube a Docker Hub la última
  imagen creada, con el número de versión definido por el número de
  <em>build</em> de Travis y también con la etiqueta <code>latest</code>.</li>
</ul>
<h3 id="builds-en-travis">Builds en Travis<a class="headerlink" href="#builds-en-travis" title="Permanent link">&para;</a></h3>
<p>En Travis tenemos toda la información de los <em>builds</em>. Es posible
visualizarla una vez ha terminado el <em>build</em> o mientras se está
ejecutando.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/02-pruebas-tdd/imagenes/builds-travis.png" width="600px"/></p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Sólo es posible ejecutar un <em>build</em> simultáneo en la organización
<code>mads-ua-18</code>. Cuando hay otro <em>build</em> ejecutándose los nuevos
<em>builds</em> que se lancen quedarán encolados por fecha de inicio.</p>
</div>
<h3 id="versiones-en-docker-hub">Versiones en Docker Hub<a class="headerlink" href="#versiones-en-docker-hub" title="Permanent link">&para;</a></h3>
<p>En Docker Hub tendremos el histórico de versiones generadas en la
integración continua. Y la última estará etiquetada con <code>latest</code>.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/02-pruebas-tdd/imagenes/docker-hub.png" width="500px"/></p>
<h3 id="pasos-a-seguir-en-la-practica_4">Pasos a seguir en la práctica<a class="headerlink" href="#pasos-a-seguir-en-la-practica_4" title="Permanent link">&para;</a></h3>
<ul>
<li>Date de alta en <a href="https://travis-ci.com">Travis-ci.com</a> y conéctalo al repositorio de la práctica.</li>
<li>Adapta el fichero <code>.travis.yml</code> a tu práctica y añádelo con un
  commit a la rama <code>integracion-continua</code>.</li>
<li>Sube el commit a GitHub y abre un <em>pull request</em> con la rama.</li>
<li>Comprueba que se pasan los tests en Travis y que se marca como
  correcto el <em>pull request</em>. Si hay algún fallo, realiza los cambios
  necesarios para corregirlos y vuelve a subir el commit.</li>
<li>Mezcla el <em>pull request</em> con <code>master</code>. Se volverán a lanzar los
  tests en Travis y se subirá la máquina docker resultante a Docker
  Hub.</li>
<li>Crea en la wiki una página llamada <code>Integración continua</code> y
  documenta en ella lo que has hecho en esta parte de la
  práctica. Como mínimo:</li>
<li>Captura de pantalla de los tests de integración con <code>sbt</code>.</li>
<li>Enlace a Docker Hub.</li>
</ul>
<h2 id="tdd">TDD<a class="headerlink" href="#tdd" title="Permanent link">&para;</a></h2>
<p>En la segunda parte de la práctica desarrollaremos, usando TDD (<em>Test
Driven Design</em>), una nueva <em>feature</em> de la aplicación: la posibilidad
de definir definir equipos a los que puedan pertenecer los usuarios.</p>
<p>Descomponemos la <em>feature</em> en las siguientes historias de usuario.</p>
<ul>
<li>008 Listado de equipos</li>
<li>009 Gestionar pertenencia al equipo</li>
<li>010 Gestión de equipos</li>
</ul>
<p><strong>008 Listado de equipos</strong>: Como usuario podré consultar el listado de
los equipos existentes y los participantes en cada uno de ellos para
poder consultar la estructura de la empresa y los proyectos en marcha
y comprobar si estoy en los equipos correctos.</p>
<p><strong>009 Gestionar pertenencia al equipo</strong>: Como usuario podré añadirme y
eliminarme de cualquier equipo para poder participar y dejar de
participar en ellos.</p>
<p><strong>010 Gestión de equipos</strong>: Como administrador podré crear, cambiar el
nombre y eliminar los equipos para adaptarlos a los proyectos y
estructura de la empresa.</p>
<p>Vamos a hacer de forma guiada la primera historia y dejamos las
siguientes para que las hagas por tu cuenta.</p>
<h3 id="008-listado-de-equipos">008 Listado de equipos<a class="headerlink" href="#008-listado-de-equipos" title="Permanent link">&para;</a></h3>
<p>La descripción de la historia de usuario es la siguiente:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Listado de equipos

Como usuario podré consultar el listado de
los equipos existentes y los participantes en cada uno de ellos para
poder consultar la estructura de la empresa y los proyectos en marcha
y comprobar si estoy en los equipos correctos.

Detalles

    * En el menú aparcerá una opción `Equipos` que llevará a un
    listado con los nombres de todos los equipos existentes.
    * El listado de equipos estará ordenado por orden alfabético.
    * Pinchando en el nombre del equipo aparecerá un listado de todos
    los usuarios que lo componen.
    * Un usuario podrá pertenecer a más de un equipo.
</pre></div>
</td></tr></table>

<p>Vamos a utilizar la técnica de TDD para construir la funcionalidad
<strong>de abajo a arriba</strong>. Comenzaremos con tests que construyan la capa
de modelo (clases de entidad y repository) y después pasaremos a tests
que construyan la capa de servicio.</p>
<p>Por último, una vez implementados los métodos de servicios necesarios,
deberás implementar (lo haremos sin tests) las vistas y
controllers. Las vistas y controllers los probaremos de forma manual,
sin tests automáticos.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Los controllers no deben implementar ningún código adicional, sólo
llamar al método de servicio necesario. De esta forma nos
aseguramos que todo el código importante para la funcionalidad está
testeado y ha sido creado mediante TDD.</p>
</div>
<p>Recuerda que los pasos seguir la técnica de TDD:</p>
<ul>
<li><strong>Test</strong>: Primero debes escribir el test.</li>
<li><strong>Code</strong>: Después debes escribir el código que hace pasar el test (<strong>únicamente el código
necesario, no puedes escribir código de más</strong>)</li>
<li><strong>Refactor</strong>: Y, si es necesario, realizar una refactorización del código (los
  tests deben seguir pasando después de la refactorización).</li>
</ul>
<p>Deberás hacer <strong>un commit por cada fase Test-Code</strong>. Si haces
refactorización deberás hacerlo en otro commit adicional.</p>
<h4>Pasos a seguir en la práctica</h4>
<ul>
<li>Crea la historia de usuario en el tablero Trello.</li>
<li>Crea los <em>issues</em> correspondientes a esta historia:<ul>
<li>Servicio y modelo listado de equipos.</li>
<li>Vista y controller listado de equipos.</li>
</ul>
</li>
<li>Crea una rama para desarrollar el primer <em>issue</em> (llámala
  <code>servicio-equipos</code>, por ejemplo) y pásalo en el
  tablero a <code>In progress</code>.</li>
</ul>
<p>Este primer <em>issue</em> lo haremos de forma guiada usando TDD con los
tests que enumeraremos a continuación. El otro <em>issue</em> lo deberás
implementar por ti mismo.</p>
<h5>Primer test - Entidiad <code>Equipo</code></h5>
<p>El primer test es para crear la entidad <code>Equipo</code>. Por ahora sólo
creamos la clase Java, sin las anotaciones JPA. Un equipo</p>
<p><strong>Fichero `src/test/java/madstodolist/EquipoTest.java</strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">madstodolist</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">madstodolist.model.Equipo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">crearEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></p>
<p>Escribe el código necesario para que pase el test. <strong>No debes escribir
código de más, sólo el código mínimo para que el test pase</strong>. Haz un
<em>commit</em> que contenga el test y el código y súbelo a la rama remota.</p>
<h5>Segundo test - Entidad en base de datos</h5>
<p>Con el segundo test queremos conseguir que funcione JPA con la entidad
<code>Equipo</code> y que podamos usar una tabla de equipos en la base de datos,
en la que podamos guardar entidades <code>equipo</code>.</p>
<p>Para comprobar que la entidad se ha guardado correctamente,
comprobaremos se ha actualizando su identificador. Lo hacemos
añadiendo el siguiente test:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">grabarEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>

        <span class="c1">// WHEN</span>
        <span class="n">equipoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">isNotNull</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Escribe el código necesario para se pase el test y haz un commit.</p>
<h5>Tercer test - Definición de igualdad entre equipos</h5>
<p>Ahora que hemos introducido el <code>id</code> del equipo escribimos un test
para comprobar que dos equipos son iguales. Debes escribir el código
de los métodos <code>equals</code> y <code>hashCode</code> (necesario este último para que
funcione correctamente la comprobación de igualdades en las
colecciones).</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarIgualdadEquipos</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Creamos tres equipos sin id, sólo con el nombre</span>
        <span class="n">Equipo</span> <span class="n">equipo1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Níquel&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Níquel&quot;</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Comprobamos igualdad basada en el atributo nombre</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo1</span><span class="o">).</span><span class="na">isNotEqualTo</span><span class="o">(</span><span class="n">equipo2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo2</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">equipo3</span><span class="o">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Añadimos identificadores y comprobamos igualdad por identificadores</span>
        <span class="n">equipo1</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">equipo2</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">equipo3</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2L</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Comprobamos igualdad basada en el atributo nombre</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo1</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">equipo2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo2</span><span class="o">).</span><span class="na">isNotEqualTo</span><span class="o">(</span><span class="n">equipo3</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Escribe el código necesario para se pase el test y haz un commit.</p>
<h5>Cuarto test - Buscar equipo en base de datos</h5>
<p>Escribimos ahora un test para recuperar equipos por su identificador
de la base de datos. Añadimos un equipo a la tabla en el fichero
<code>datos-test.sql</code> para poder comprobar que funciona correctamente.</p>
<p>Añadimos en el fichero <strong><code>src/test/java/resources/datos-test.sql</code></strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>INSERT INTO equipos (id, nombre) VALUES(&#39;1&#39;, &#39;Proyecto Cobalto&#39;);
</pre></div>
</td></tr></table></p>
<p>Test:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRecuperarEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>

        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Comprueba el test y si es necesario escribe el código estríctamente
necesario para que pase.</p>
<p>Haz un commit en la rama y súbelo a GitHub.</p>
<h5>Quinto test - Relación en memoria muchos-a-muchos entre equipos y usuarios</h5>
<p>Vamos ahora a diseñar un test que introduzca la relación entre equipos
y usuarios. Debe ser una relación muchos-a-muchos: un equipo contiene
muchos usuarios y un usuario puede pertenecer a 0, 1 o muchos equipos.</p>
<p>Empezamos por un test para crear la relación en memoria, con las
anotaciones mínimas para que JPA no se queje:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">relaciónMuchosAMuchosVacia</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>

        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Usuario</span><span class="o">(</span><span class="s">&quot;prueba@gmail.com&quot;</span><span class="o">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// THEN</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">()).</span><span class="na">isEmpty</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Para que este test funcione hay que crear la relación muchos-a-muchos
entre equipos y usuarios. Por sólo la definimos en memoria, sin
especificar cómo se mapea en la base de datos:</p>
<p><strong>Fichero <code>src/main/java/madstodolist/model/Equipo.java</code></strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    private String nombre;
<span class="gi">+    @ManyToMany</span>
<span class="gi">+    Set&lt;Usuario&gt; usuarios = new HashSet&lt;&gt;();</span>

...

    public void setId(Long id) {
        this.id = id;
    }

<span class="gi">+    public Set&lt;Usuario&gt; getUsuarios() {</span>
<span class="gi">+        return usuarios;</span>
<span class="gi">+    }</span>
</pre></div>
</td></tr></table></p>
<p><strong>Fichero <code>src/main/java/madstodolist/model/Usuario.java</code></strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    @OneToMany(mappedBy = &quot;usuario&quot;, fetch = FetchType.EAGER)
    Set&lt;Tarea&gt; tareas = new HashSet&lt;&gt;();

<span class="gi">+    @ManyToMany</span>
<span class="gi">+    Set&lt;Equipo&gt; equipos = new HashSet&lt;&gt;();</span>

...

<span class="gi">+    public Set&lt;Equipo&gt; getEquipos() {</span>
<span class="gi">+        return equipos;</span>
<span class="gi">+    }</span>
</pre></div>
</td></tr></table></p>
<h5>Sexto test - Relación entre usuarios y equipos en base de datos</h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>INSERT INTO tareas (id, titulo, usuario_id) VALUES(&#39;2&#39;, &#39;Renovar DNI&#39;, &#39;1&#39;);
<span class="gi">+ INSERT INTO equipos (id, nombre) VALUES(&#39;1&#39;, &#39;Proyecto Cobalto&#39;);</span>
<span class="gi">+ INSERT INTO equipo_usuario (fk_equipo, fk_usuario) VALUES(&#39;1&#39;, &#39;1&#39;);</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UsuarioRepository</span> <span class="n">usuarioRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRelacionBaseDatos</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="c1">// THEN</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Solución:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    @ManyToMany
<span class="gi">+    @JoinTable(name = &quot;equipo_usuario&quot;,</span>
<span class="gi">+            joinColumns = { @JoinColumn(name = &quot;fk_equipo&quot;) },</span>
<span class="gi">+            inverseJoinColumns = {@JoinColumn(name = &quot;fk_usuario&quot;)})</span>
    Set&lt;Usuario&gt; usuarios = new HashSet&lt;&gt;();
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="gd">-    @ManyToMany</span>
<span class="gi">+    @ManyToMany(mappedBy = &quot;usuarios&quot;)</span>
    Set&lt;Equipo&gt; equipos = new HashSet&lt;&gt;();
</pre></div>
</td></tr></table>

<h5>Séptimo test - listado de equipos</h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>INSERT INTO equipo_usuario (fk_equipo, fk_usuario) VALUES(&#39;1&#39;, &#39;1&#39;);
<span class="gi">+ INSERT INTO equipos (id, nombre) VALUES(&#39;2&#39;, &#39;Proyecto Adamantium&#39;);</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarFindAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Solución:</p>
<p><strong>Fichero <code>EquipoRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="gi">+ import java.util.List;</span>

public interface EquipoRepository extends CrudRepository&lt;Equipo, Long&gt; {
<span class="gi">+     public List&lt;Equipo&gt; findAll();</span>
}
</pre></div>
</td></tr></table>

<h5>Octavo test - Método de servicio para el listado de equipos</h5>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">madstodolist</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">madstodolist.model.Equipo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">madstodolist.service.EquipoService</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

 <span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

 <span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
 <span class="nd">@SpringBootTest</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoServiceTest</span> <span class="o">{</span>

     <span class="nd">@Autowired</span>
     <span class="n">EquipoService</span> <span class="n">equipoService</span><span class="o">;</span>

     <span class="nd">@Test</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtenerListadoEquipos</span><span class="o">()</span> <span class="o">{</span>
         <span class="c1">// GIVEN</span>
         <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

         <span class="c1">// WHEN</span>
         <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">findAllOrderedByName</span><span class="o">();</span>

         <span class="c1">// THEN</span>
         <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
         <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Adamantium&quot;</span><span class="o">);</span>
         <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table>

<h5>Noveno test - Método de servicio para recuperar un equipo</h5>
<p>En el fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code>
añadimos el siguiente test.</p>
<p>El test sirve para crear el método de servicio que recupera un equipo
y para asegurarnos de que la relación entre equipos y usuarios es <code>LAZY</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtenerEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="c1">// Comprobamos que la relación con Usuarios es lazy: al</span>
        <span class="c1">// intentar acceder a la colección de usuarios se debe lanzar una</span>
        <span class="c1">// excepción de tipo LazyInitializationException.</span>
        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}).</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">LazyInitializationException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<h5>Décimo test - Método de servicio para obtener los usuarios de un equipo</h5>
<p>Un test algo complejo, que sirve para definir el método de servicio
<code>usuariosEquipo(Long idEquipo)</code> que devuelve la lista de usuarios de
un equipo.</p>
<p>Después de comprobar que la lista que se devuelve es correcta, se
comprueba que la relación entre usuarios y equipos es <code>EAGER</code>, esto
es, que desde un usuario se puede obtener la lista de equipos a los
que pertenece.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtenerUsuariosEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">usuariosEquipo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getEmail</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="o">);</span>
        <span class="c1">// Comprobamos que la relación entre usuarios y equipos es eager</span>
        <span class="c1">// Primero comprobamos que la colección de equipos tiene 1 elemento</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">// Y después que el elemento es el equipo Proyecto Cobalto</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">findFirst</span><span class="o">().</span><span class="na">get</span><span class="o">().</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h3 id="pasos-a-seguir-en-la-practica_5">Pasos a seguir en la práctica<a class="headerlink" href="#pasos-a-seguir-en-la-practica_5" title="Permanent link">&para;</a></h3>
<ul>
<li>Crea una <em>feature</em> nueva en la wiki, un nuevo <em>issue</em> para
  resolverla (con el <em>milestone</em> 1.2.0) y una nueva rama en la que
  desarrollarás el <em>issue</em>. </li>
<li>Completa el código para pasar los tests, uno a uno, <strong>haciendo un
  commit después de cada fase test-code</strong> y otro en la fase
  <strong>refactor</strong> (en el caso en que tengas que hacer refactorización).</li>
<li>Continua usando TDD y haciendo commits <strong>test-code</strong> y <strong>refactor</strong>
  para terminar de implementar la <em>feature</em>, escribiendo los tests
  necesarios para terminar de implementar la capa de repositorio y la
  capa de servicio con los métodos necesarios para implementar la
  nueva funcionalidad. Los incrementos de código introducidos por los
  tests deben ser pequeños. Debe haber <strong>entre 15 y 25 líneas de
  código</strong> añadidas en las fases de codificación (sin contar el código
  de los tests). No tomes este número de forma demasiado estricta; si
  en algún ciclo hay que añadir 35 líneas no pasa nada. Tampoco si
  haces menos de 15. Pero estaría mal tener que añadir 70 líneas para
  resolver un test.</li>
<li>Termina de implementar la historia de usuario modificando las vistas
  y los controllers necesarios.</li>
<li>Crea un <em>pull request</em> y mezcla en <code>master</code> la nueva
  funcionalidad. Se subirá a Docker Hub la nueva versión de la máquina docker.</li>
<li>Realiza el nuevo <em>release</em> con el número <code>1.2.0</code>, genera a mano la máquina
  docker con esa versión y súbela a Docker Hub.</li>
</ul>
<h2 id="entrega-y-evaluacion">Entrega y evaluación<a class="headerlink" href="#entrega-y-evaluacion" title="Permanent link">&para;</a></h2>
<ul>
<li>La práctica tiene una duración de 3 semanas y debe estar terminada
  el martes 30 de octubre.</li>
<li>La calificación de la práctica tiene un peso de un 8% en la nota
  final de la asignatura. </li>
<li>Para realizar la entrega se debe subir a Moodle un ZIP que contenga
  todo el proyecto, incluyendo el directorio <code>.git</code> que contiene la
  historia Git. Para ello comprime tu directorio local del proyecto
  <strong>después de haber hecho un <code>clean</code> en <code>sbt</code></strong> para eliminar el
  directorio <code>target</code> que contiene los binarios compilados. Debes
  dejar también en Moodle la URL del repositorio en GitHub y la URL de
  la máquina en Docker Hub.</li>
</ul>
<p>Para la evaluación se tendrá en cuenta:</p>
<ul>
<li>Desarrollo continuo (los <em>commits</em> deben realizarse a lo largo de
  las 3 semanas y no dejar todo para la última semana).</li>
<li>Correcto desarrollo de la metodología.</li>
<li>Diseño e implementación del código y de los tests de las
  características desarrolladas.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>