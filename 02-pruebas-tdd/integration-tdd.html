



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Práctica 2 - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#practica-2-integracion-con-travis-y-tdd" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Prácticas MADS" class="md-header-nav__button md-logo">
          
            <img src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Prácticas MADS
            </span>
            <span class="md-header-nav__topic">
              Práctica 2
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo">
      
        <img src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Práctica 0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Práctica 0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/intro-spring-boot.html" title="Introducción a Sprign Boot para MADS" class="md-nav__link">
      Introducción a Sprign Boot para MADS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/comandos-git.html" title="Comandos Git" class="md-nav__link">
      Comandos Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica0.html" title="Práctica 0" class="md-nav__link">
      Práctica 0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica1.html" title="Práctica 1" class="md-nav__link">
      Práctica 1
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Práctica 2
      </label>
    
    <a href="integration-tdd.html" title="Práctica 2" class="md-nav__link md-nav__link--active">
      Práctica 2
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#desarrollo-de-la-release-120" title="Desarrollo de la release 1.2.0" class="md-nav__link">
    Desarrollo de la release 1.2.0
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refactorizacion-de-la-relacion-uno-a-muchos" title="Refactorización de la relación uno-a-muchos" class="md-nav__link">
    Refactorización de la relación uno-a-muchos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-la-aplicacion" title="Configuración de la aplicación" class="md-nav__link">
    Configuración de la aplicación
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ficheros-de-configuracion-de-la-aplicacion" title="Ficheros de configuración de la aplicación" class="md-nav__link">
    Ficheros de configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integracion-continua-con-travis" title="Integración continua con Travis" class="md-nav__link">
    Integración continua con Travis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conexion-con-github" title="Conexión con GitHub" class="md-nav__link">
    Conexión con GitHub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests-en-los-pull-requests" title="Tests en los pull requests" class="md-nav__link">
    Tests en los pull requests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#el-fichero-de-configuracion" title="El fichero de configuración" class="md-nav__link">
    El fichero de configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#builds-en-travis" title="Builds en Travis" class="md-nav__link">
    Builds en Travis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maven-wrapper" title="Maven Wrapper" class="md-nav__link">
    Maven Wrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tdd" title="TDD" class="md-nav__link">
    TDD
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#008-listado-de-equipos" title="008 Listado de equipos" class="md-nav__link">
    008 Listado de equipos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_4" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resto-de-historias-de-usuario" title="Resto de historias de usuario" class="md-nav__link">
    Resto de historias de usuario
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_5" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-y-evaluacion" title="Entrega y evaluación" class="md-nav__link">
    Entrega y evaluación
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-gitflow-despliegue/gitflow-despliegue.html" title="Práctica 3" class="md-nav__link">
      Práctica 3
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#desarrollo-de-la-release-120" title="Desarrollo de la release 1.2.0" class="md-nav__link">
    Desarrollo de la release 1.2.0
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refactorizacion-de-la-relacion-uno-a-muchos" title="Refactorización de la relación uno-a-muchos" class="md-nav__link">
    Refactorización de la relación uno-a-muchos
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-la-aplicacion" title="Configuración de la aplicación" class="md-nav__link">
    Configuración de la aplicación
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ficheros-de-configuracion-de-la-aplicacion" title="Ficheros de configuración de la aplicación" class="md-nav__link">
    Ficheros de configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integracion-continua-con-travis" title="Integración continua con Travis" class="md-nav__link">
    Integración continua con Travis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conexion-con-github" title="Conexión con GitHub" class="md-nav__link">
    Conexión con GitHub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests-en-los-pull-requests" title="Tests en los pull requests" class="md-nav__link">
    Tests en los pull requests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#el-fichero-de-configuracion" title="El fichero de configuración" class="md-nav__link">
    El fichero de configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#builds-en-travis" title="Builds en Travis" class="md-nav__link">
    Builds en Travis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maven-wrapper" title="Maven Wrapper" class="md-nav__link">
    Maven Wrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tdd" title="TDD" class="md-nav__link">
    TDD
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#008-listado-de-equipos" title="008 Listado de equipos" class="md-nav__link">
    008 Listado de equipos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_4" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resto-de-historias-de-usuario" title="Resto de historias de usuario" class="md-nav__link">
    Resto de historias de usuario
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_5" title="Pasos a seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-y-evaluacion" title="Entrega y evaluación" class="md-nav__link">
    Entrega y evaluación
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="practica-2-integracion-con-travis-y-tdd">Práctica 2: Integración con Travis y TDD<a class="headerlink" href="#practica-2-integracion-con-travis-y-tdd" title="Permanent link">&para;</a></h1>
<p>En esta práctica 2 de la asignatura realizaremos dos tareas principales:</p>
<ul>
<li>Configuraremos un sistema de integración continua conectando el
  repositorio de GitHub con Travis. En este sistema se lanzarán los
  tests automáticamente en cada <em>pull request</em> sobre la base de datos
  MySQL.</li>
<li>Añadiremos nuevas funcionalidades usando la práctica XP de TDD
  (<em>Test Driven Design</em>).</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Lee con cuidado todo el enunciado y dedica especial atención a los
apartados con el título <code>Pasos a seguir</code>. Ahí están
especificadas las acciones que debes realizar en la práctica.</p>
</div>
<p>La duración de la práctica es de 3 semanas y la fecha límite de
entrega es el día 5 de noviembre.</p>
<h2 id="desarrollo-de-la-release-120">Desarrollo de la <em>release</em> 1.2.0<a class="headerlink" href="#desarrollo-de-la-release-120" title="Permanent link">&para;</a></h2>
<p>En esta práctica vamos a desarrollar la versión 1.2.0 de la aplicación
<code>ToDoList</code>. A todos los <em>issues</em> y <em>pull requests</em> les debes poner este
<em>milestone</em>, indicando que el objetivo es resolverlos y entregarlos en
esta <em>release</em>.</p>
<h3 id="pasos-a-seguir">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir" title="Permanent link">&para;</a></h3>
<ul>
<li>Cambia el número de versión (en el fichero <em>Acerca De</em> y en el
  <code>pom.xml</code>) a <code>1.2.0-SNAPSHOT</code> para indicar que lo que hay en master
  es la versión 1.2.0 <strong>en progreso</strong>. Esta versión la lanzaremos al
  final del desarrollo de la práctica, en su entrega.</li>
</ul>
<h2 id="refactorizacion-de-la-relacion-uno-a-muchos">Refactorización de la relación uno-a-muchos<a class="headerlink" href="#refactorizacion-de-la-relacion-uno-a-muchos" title="Permanent link">&para;</a></h2>
<p>Antes de comenzar la práctica hay que hacer una refactorización en la
relación una-a-muchos entre usuario y tareas: pasar la lista de tareas
de un usuario de <code>List</code> a <code>Set</code>. </p>
<p>A diferencias del tipo <code>List</code>, el <code>Set</code> no permite elementos repetidos
y es más conveniente definir las relaciones JPA de esta forma.</p>
<h3 id="pasos-a-seguir_1">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Realiza un commit en <code>master</code> (no hace falta que hagas un pull
  request) con los cambios que aparecen este <a href="https://github.com/domingogallardo/mads-todolist-inicial/commit/498442afc689e81cc02d5022cfa6a85722a56bc7">commit</a>.</li>
<li>Lanza los tests para comprobar que todo funciona correctamente y
  sube el commit a GitHub.</li>
</ul>
<h2 id="configuracion-de-la-aplicacion">Configuración de la aplicación<a class="headerlink" href="#configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h2>
<p>Hasta ahora hemos trabajado con la aplicación en una configuración
local con nuestro ordenador de desarrollo trabajando sobre una base de
datos H2 en memoria. Pero el objetivo final es poner la aplicación en
producción, en un servidor en Internet y usando una base de datos
MySQL de producción. </p>
<p>En esta práctica vamos a configurar un perfil de la aplicación para
poder lanzar los tests y ejecutar la aplicación usando una base de
datos MySQL. En la práctica 3 veremos cómo definir un perfil para
trabajar con una base de datos de producción.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La <strong>base de datos de producción</strong> es la que mantiene los datos
introducidos por los usuarios de la misma. Hay que prestar una
atención especial a esta base de datos y definir políticas de
respaldo y de control de cambios para evitar que se produzca
cualquier pérdida de información. Veremos en la práctica 3 que una
de las cuestiones que hay que asegurar es que la aplicación no
puede modificar el esquema de datos de esta base de datos. Habrá
que definir un flujo de trabajo para implementar en el esquema de
datos de la base de datos un cambio en el modelo de datos de la
aplicación.</p>
</div>
<p>Vamos a ver en este apartado cómo definir distintas configuraciones de
ejecución de la aplicación, utilizando los denominados
<em>perfiles</em>. Definiremos, además del perfil base, un perfil adicional
para lanzar la aplicación y los tests usando la base de datos MySQL.</p>
<p>La configuración de tests con base de datos MySQL la utilizaremos para
ejecutar los tests de integración en el proceso de integración
continua de Travis.</p>
<h3 id="ficheros-de-configuracion-de-la-aplicacion">Ficheros de configuración de la aplicación<a class="headerlink" href="#ficheros-de-configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>Ya hemos comentado que la configuración de la aplicación se define en
el fichero <code>application.properties</code>. Ahí se definen distintas
propiedades de la ejecución de la aplicación que se pueden modificar
(puerto en el que se lanza la aplicación, base de datos con la que
conectarse, etc.). </p>
<p>Tenemos dos ficheros <code>application.properties</code>: uno en el directorio
<code>src/main/resources</code> que define la configuración de ejecución y otro
en el directorio <code>src/test/resources</code> que define la configuración que
se carga cuando se lanzan los tests.</p>
<p>Spring Boot permite definir ficheros de configuración adicionales que
pueden sobreescribir las propiedades definidas en el fichero de
configuración por defecto. El nombre de estos ficheros de
configuración debe ser <code>application-xxx.properties</code> donde <code>xxx</code> define el
nombre del perfil. En nuestro caso definiremos los ficheros
<code>application-mysql.properties</code> (uno en el directorio <code>main</code> y otro en
<code>test</code>) para definir las configuraciones de ejecución y de test con
MySQL.</p>
<h3 id="pasos-a-seguir_2">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_2" title="Permanent link">&para;</a></h3>
<ul>
<li>Instala <a href="https://www.docker.com/products/docker-desktop">Docker
  Desktop</a>. </li>
</ul>
<p>Docker es un software de virtualización que utiliza el propio
  sistema operativo compartimentado y permite gestionar <em>contenedores</em>
  (similares a las máquinas virtuales) de forma mucho menos pesada y
  rápida que con sistemas de virtualización tradicionales como
  VirtualBox.</p>
<p>Lo vamos a utilizar para <strong>lanzar el servidor MySQL de base de
  datos</strong> y también para la futura práctica 3.</p>
<p><strong>Si tienes Windows, Docker no es compatible con VirtualBox</strong>. Si
  quieres usar ambos programas puedes usar una versión limitada de
  Docker llamada <a href="https://docs.docker.com/toolbox/toolbox_install_windows/">Docker
  Toolbox</a>.</p>
<p><strong>Si tienes Ubuntu</strong> debes instalar Docker usando <code>apt</code>. Aquí tienes
  un tutorial para <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04">instalar Docker en Ubuntu
  18.04</a>.</p>
<ul>
<li>
<p>Crea un nuevo <em>issue</em> llamado <code>Añadir perfiles y permitir trabajar
  con MySQL</code>. Crea una rama nueva (llámala <code>perfiles</code>, por ejemplo) y
  abre un pull request. </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ <span class="o">(</span>master<span class="o">)</span> git checkout -b perfiles
$ <span class="o">(</span>perfiles<span class="o">)</span> git push -u origin perfiles
</pre></div>
</td></tr></table>

</li>
<li>
<p>Copia el siguiente fichero en <code>src/main/resources/application-mysql.properties</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>spring.datasource.url=jdbc:mysql://localhost:3306/mads
spring.datasource.username=root
spring.datasource.password=
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5InnoDBDialect
spring.jpa.hibernate.ddl-auto=update
spring.datasource.initialization-mode=never
</pre></div>
</td></tr></table>

</li>
</ul>
<p>En este fichero de configuración se define la URL de conexión a la
   base de datos MySQL, su usuario (<code>root</code>) y contraseña (vacía) y el
   dialecto que se va a utilizar para trabajar desde JPA con la base
   de datos (<code>org.hibernate.dialect.MySQL5InnoDBDialect</code>). Además se indica
   que no se debe cargar ningún fichero de datos inicial. El esquema
   de la base de datos se actualizará si hay cambios en las entidades
   de la aplicación, y los datos se mantendrán en la base de datos.</p>
<ul>
<li>
<p>Copia el siguiente fichero en <code>src/test/resources/application-mysql.properties</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>spring.datasource.url=jdbc:mysql://localhost:3306/mads_test
spring.datasource.username=root
spring.datasource.password=
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5InnoDBDialect
spring.jpa.hibernate.ddl-auto=create
</pre></div>
</td></tr></table>

</li>
</ul>
<p>La diferencia más importante es el valor de
   <code>spring.jpa.hibernate.ddl-auto</code>, que es <code>create</code>. De esta forma la
   base de datos se inicializa antes de cargar los datos de los tests
   y de ejecutarlos. También usamos una base de datos distinta
   (<code>mads_test</code>) para no sobreescribir la base de datos definida en el
   perfil de ejecución.</p>
<ul>
<li>
<p>Añade la siguiente dependencia en el fichero <code>pom.xml</code> para que se
  descargue el driver <code>mysql-connector-java</code> y poder utilizar una base
  de datos MySQL en la aplicación:</p>
<p>Fichero <code>pom.xml</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>            &lt;artifactId&gt;h2&lt;/artifactId&gt;
             &lt;scope&gt;runtime&lt;/scope&gt;
         &lt;/dependency&gt;
<span class="gi">+         &lt;dependency&gt;</span>
<span class="gi">+             &lt;groupId&gt;mysql&lt;/groupId&gt;</span>
<span class="gi">+             &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span>
<span class="gi">+         &lt;/dependency&gt;</span>
         &lt;dependency&gt;
             &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</pre></div>
</td></tr></table>

</li>
<li>
<p>Para lanzar la aplicación necesitarás un servidor MySQL en el puerto
  3306 con el usuario <code>root</code> sin contraseña. Es muy sencillo
  descargarlo y ejecutarlo si tienes instalado Docker. Ejecuta desde
  el terminal:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -d -p 3306:3306 --name mysql-develop -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_DATABASE=mads mysql:5 
</pre></div>
</td></tr></table>

<p>Docker se descarga la imagen <code>mysql:5</code> y lanza el contenedor (una
instancia en marcha de una imagen) conectado al puerto 3306 y
sobre la base de datos <code>mads</code>. Le da como nombre <code>mysql-develop</code>.</p>
<p>Puedes ejecutar los siguientes comandos de Docker:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container ls -a <span class="o">(</span>comprueba todos los contenedores en marcha<span class="o">)</span>
$ docker container stop &lt;nombre o id de contenedor&gt; <span class="o">(</span>para un contenedor<span class="o">)</span>
$ docker container rm nombre o id de contenedor&gt; <span class="o">(</span>elimina un contenedor<span class="o">)</span>
</pre></div>
</td></tr></table>

</li>
<li>
<p>Arranca la aplicación con el siguiente comando:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mvn spring-boot:run -Dspring.profiles.active=mysql
</pre></div>
</td></tr></table>

<p>Se activará el perfil <code>mysql</code> y se cargarán las preferencias de
<code>src/main/resource/application.properties</code> y
<code>src/main/resource/application-mysql.properties</code>.</p>
<p>Prueba a introducir datos en la aplicación y comprueba que se
están guardando en la base de datos con <em>MySQL Workbench</em> o alguna
aplicación similar.</p>
<p><img src="imagenes/mysql-workbench.png" width="700px"/></p>
</li>
<li>
<p>Cierra la aplicación y vuelve a abrirla. Comprueba que los datos que
  se han creado en la ejecución anterior siguen estando.</p>
</li>
<li>
<p>Cierra la aplicación. Paramos el contenedor con la base de datos de
  desarrollo haciendo <code>docker container stop</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container ls -a 
CONTAINER ID        IMAGE     ...    NAME
520fee61d51e        mysql:5   ...    mysql-develop
$ docker container stop mysql-develop
</pre></div>
</td></tr></table>

</li>
<li>
<p>Lanzamos ahora otro contenedor con la base de datos de test:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -d -p 3306:3306 --name mysql-test -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_DATABASE=mads_test mysql:5 
</pre></div>
</td></tr></table>

<p>Y lanzamos los tests usando el perfil ` la base de datos MySQL con el siguiente comando:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mvn test -Dspring.profiles.active=mysql
</pre></div>
</td></tr></table>

<p>Comprobamos con <em>MySQL Workbench</em> que los datos que hay en
la base de datos corresponden con los introducidos en el fichero
<code>datos-test.sql</code> que se carga antes de ejecutar los tests.</p>
</li>
<li>
<p>Podemos parar y arrancar el contenedor MySQL que necesitemos con
  <code>docker container stop</code> y <code>docker container start</code>. Por ejemplo,
  para parar el contenedor MySQL con la base de datos de test y
  arrancar el contenedor con la base de datos de desarrollo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container ls -a 
$ docker container stop mysql-test
$ docker container start mysql-develop
</pre></div>
</td></tr></table>

</li>
<li>
<p>Realiza un commit con los cambios, súbelos a la rama y cierra el
  pull request para integrarlo en <code>master</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ <span class="o">(</span>perfiles<span class="o">)</span> git add .
$ <span class="o">(</span>perfiles<span class="o">)</span> git commit -m <span class="s2">&quot;Añadidos perfiles para trabajar con MySQL&quot;</span>
$ <span class="o">(</span>perfiles<span class="o">)</span> git push
// Mezclamos el Pull Request en GitHub
$ <span class="o">(</span>perfiles<span class="o">)</span> git checkout master
$ <span class="o">(</span>master<span class="o">)</span> git pull
$ <span class="o">(</span>master<span class="o">)</span> git branch -d perfiles
$ <span class="o">(</span>master<span class="o">)</span> git remote prune origin
</pre></div>
</td></tr></table>

</li>
</ul>
<h2 id="integracion-continua-con-travis">Integración continua con Travis<a class="headerlink" href="#integracion-continua-con-travis" title="Permanent link">&para;</a></h2>
<p><a href="https://travis-ci.com/">Travis-ci.com</a> es un servicio que permite realizar
integración continua on-line, sin necesidad de configurar un servidor
propio de integración continua.</p>
<p>Es un servicio de pago, pero es gratuito para los repositorios
abiertos (<em>open source</em>) y para las cuentas educativas de GitHub. La
organización de GitHub <code>mads-ua</code> también está autorizada como
organización educativa, por lo que todos los repositorios creados
dentro de esa organización podrán trabajar con Travis.</p>
<p>Puedes consultar el funcionamiento de Travis leyendo su documentación,
comenzando por la página <a href="https://docs.travis-ci.com/user/getting-started/">Getting
started</a>.</p>
<p>En la práctica vamos a configurar Travis para que todos los <em>pull
requests</em> deban pasar los tests de integración (conectándose a la base
de datos MySQL) antes de realizar el <em>merge</em> con <code>master</code>. </p>
<h3 id="conexion-con-github">Conexión con GitHub<a class="headerlink" href="#conexion-con-github" title="Permanent link">&para;</a></h3>
<p>En GitHub está configurada la conexión con Travis para todos los
proyectos en la organización <code>mads-ua</code>. </p>
<p>En tu cuenta de Travis, una vez logeado, podrás acceder a tu
repositorio en la organización <code>mads-ua</code> y comprobar su
configuración. Verás una pantalla como la siguiente:</p>
<p><img src="imagenes/conexion-travis.png" width="700px"/></p>
<h3 id="tests-en-los-pull-requests">Tests en los pull requests<a class="headerlink" href="#tests-en-los-pull-requests" title="Permanent link">&para;</a></h3>
<p>Usando Travis es posible configurar el repositorio de GitHub para que todos los
<em>pull requests</em> deban pasar los tests de integración en el servicio.</p>
<p>En la siguiente imagen vemos el aspecto en GitHub de un <em>pull request</em>
estando activa la integración con Travis. Una vez abierto el PR,
Travis comprueba si la integración de master con la rama pasa los
tests definidos en el fichero de configuración. Sólo si los tests
pasan es posible realizar el <em>merge</em> del PR en master.</p>
<p><img src="imagenes/pull-request-travis.png" width="600px"/></p>
<h3 id="el-fichero-de-configuracion">El fichero de configuración<a class="headerlink" href="#el-fichero-de-configuracion" title="Permanent link">&para;</a></h3>
<p>La configuración de Travis se realiza con el fichero <code>.travis.yml</code> en
la raíz del repositorio.</p>
<p>El fichero <code>.travis.yml</code> para mi repositorio solución de la práctica
es el siguiente:</p>
<p><strong>Fichero <code>.travis.yml</code></strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>language: java

branches:
  only:
    - master

services:
  - mysql

before_install:
  - mysql -e &#39;CREATE DATABASE mads_test;&#39;

script: ./mvnw test -Dspring.profiles.active=mysql
</pre></div>
</td></tr></table>

<p>Puntos interesantes a destacar:</p>
<ul>
<li>Se puede espeficar la rama en la que se activa la integración
  continua en el apartado <code>branches</code>. En nuestro caso es la rama
  <code>master</code>. En cualquier commit o <em>pull request</em> que se haga sobre esa
  rama se lanzará la integración continua.</li>
<li>El apartado <code>services</code> define los servicios necesarios para que se
  ejecute el script de integración. En nuestro caso <code>mysql</code>. Cuando se
  lance travis se lanzará un servidor de MySQL en el puerto por
  defecto (3306) y con usuario <code>root</code> sin contraseña.</li>
<li>En el apartado <code>before_install</code> se definen los comandos a realizar
  antes de ejecutar el <em>script</em> con los tests. En nuestro caso
  se ejecuta un comando sobre el servicio <code>mysql</code> para crear la base
  de datos <code>mads_test</code> vacía.</li>
<li>En el apartado <code>script</code> se definen los comandos a realizar para
  lanzar los tests. En nuestro caso lanzamos el comando <code>mvnw</code> que
  lanza el Maven instalado en el repositorio (ver punto siguiente).</li>
</ul>
<h3 id="builds-en-travis">Builds en Travis<a class="headerlink" href="#builds-en-travis" title="Permanent link">&para;</a></h3>
<p>En Travis tenemos toda la información de los <em>builds</em>. Es posible
visualizarla una vez ha terminado el <em>build</em> o mientras se está
ejecutando. Allí podremos ver el detalle de la ejecución de los tests
y consultar la salida de los mismos para comprobar su </p>
<p><img src="imagenes/builds-travis.png" width="600px"/></p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Sólo es posible ejecutar un <em>build</em> simultáneo en la organización
<code>mads-ua</code>. Cuando hay otro <em>build</em> ejecutándose los nuevos
<em>builds</em> que se lancen quedarán encolados por fecha de inicio.</p>
</div>
<h3 id="maven-wrapper">Maven Wrapper<a class="headerlink" href="#maven-wrapper" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/takari/maven-wrapper">Maven Wrapper</a> es una forma
muy sencilla de distribuir un proyecto que use Maven para que se pueda
construir en un sistema operativo en el que Maven no esté
instalado. </p>
<p>En el propio repositorio se instala una versión de Maven que se puede
lanzar desde cualquier sistema operativo.</p>
<p>Lo utilizaremos para no tener que instalar Maven en Travis. Así
podremos lanzar los tests en Travis con un único comando que se
ejecuta usando el Maven del propio proyecto.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./mvnw test -Dspring.profiles.active=mysql
</pre></div>
</td></tr></table>

<h3 id="pasos-a-seguir_3">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_3" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Crea un <em>issue</em> llamado <code>Integración continua con Travis</code>. Abre una
  rama <code>travis</code>, súbela a GitHub y abre un pull request.</p>
</li>
<li>
<p>Instala Maven Wrapper en tu repositorio:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mvn -N io.takari:maven:wrapper
</pre></div>
</td></tr></table>

<p>Con este comando se instala Maven en tu propio respositorio (en el
directorio <code>.mvn</code>) y se instalan los comandos <code>mvnw</code> (para Linux)
y <code>mvnw.cmd</code> (para Windows).</p>
<p><strong>Si estás en Windows</strong> deberás actualizar el permiso de ejecución
del comando <code>mvnw</code> con la siguiente instrucción:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>git update-index --chmod=+x mvnw
</pre></div>
</td></tr></table>

<p>Prueba que funciona correctamente ejecutando los tests con el
comando <code>./mvnw</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./mvnw test -Dspring.profiles.active=mysql
</pre></div>
</td></tr></table>

<p>Elimina del fichero <code>.gitignore</code> la línea <code>.mvn</code> (por un error se
ha introducido esa línea desde el comienzo de la práctica) para
que los ficheros necesarios de Maven Wrapper (en el directorio
<code>.mvn/wrapper</code>) se incluyan en el repositorio:</p>
<p><strong>Fichero <code>.gitignore</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>target/
<span class="gd">- .mvn</span>
.idea
*.iml
</pre></div>
</td></tr></table>

<p>Crea un commit y súbelo a GitHub.</p>
</li>
<li>
<p>Añade el fichero <code>.travis.yml</code> en la raíz del repositorio. Haz otro
  commit y súbelo a GitHub.</p>
</li>
<li>
<p>Date de alta en <a href="https://travis-ci.com">Travis-ci.com</a> y conéctalo
  al repositorio de la práctica.</p>
</li>
<li>
<p><strong>Comprueba que se pasan los tests en Travis</strong> y que se marca como
  correcto el <em>pull request</em>. </p>
</li>
<li>
<p>Modifica un test para que falle y sube un nuevo commit. Comprueba
  que el commit aparece como erróneo en GitHub cuando el <em>build</em> de
  Travis falla. Vuelve a realizar los cambios para corregirlos,
  vuelve a subir el commit y comprueba que el nuevo commit y el PR
  pasan correctamente.</p>
</li>
<li>
<p>Cierra el <em>pull request</em> con <code>master</code>. Se volverán a lanzar los
  tests en Travis y el commit aparecerá marcado como correcto. Baja
  los cambios al repositorio local y borra la rama.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ <span class="o">(</span>travis<span class="o">)</span> git checkout master
$ <span class="o">(</span>master<span class="o">)</span> git pull
$ <span class="o">(</span>master<span class="o">)</span> git branch -d travis
$ <span class="o">(</span>master<span class="o">)</span> git remote prune origin
</pre></div>
</td></tr></table>

</li>
</ul>
<h2 id="tdd">TDD<a class="headerlink" href="#tdd" title="Permanent link">&para;</a></h2>
<p>En la segunda parte de la práctica desarrollaremos, usando TDD (<em>Test
Driven Design</em>), una nueva <em>feature</em> de la aplicación: la posibilidad
de definir definir equipos a los que puedan pertenecer los usuarios.</p>
<p>Descomponemos la <em>feature</em> en las siguientes historias de usuario.</p>
<ul>
<li>008 Listado de equipos</li>
<li>009 Gestionar pertenencia al equipo</li>
<li>010 Gestión de equipos (opcional)</li>
</ul>
<p><strong>008 Listado de equipos</strong>: Como usuario podré consultar el listado de
los equipos existentes y los participantes en cada uno de ellos para
poder consultar la estructura de la empresa y los proyectos en marcha
y comprobar si estoy en los equipos correctos.</p>
<p><strong>009 Gestionar pertenencia al equipo</strong>: Como usuario podré crear
nuevos equipos y añadirme y eliminarme de cualquiera de ellos para poder
participar y dejar de participar en ellos.</p>
<p><strong>010 Gestión de equipos (opcional)</strong>: Como administrador podré
cambiar el nombre y eliminar los equipos para adaptarlos a los
proyectos y estructura de la empresa.</p>
<p>Vamos a hacer de forma guiada la primera historia y dejamos las
siguientes para que las hagas por tu cuenta.</p>
<h3 id="008-listado-de-equipos">008 Listado de equipos<a class="headerlink" href="#008-listado-de-equipos" title="Permanent link">&para;</a></h3>
<p>La descripción de la historia de usuario es la siguiente:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Listado de equipos

Como usuario podré consultar el listado de
los equipos existentes y los participantes en cada uno de ellos para
poder consultar la estructura de la empresa y los proyectos en marcha
y comprobar si estoy en los equipos correctos.

Detalles

    * En el menú aparcerá una opción `Equipos` que llevará a un
    listado con los nombres de todos los equipos existentes.
    * El listado de equipos estará ordenado por orden alfabético.
    * Pinchando en el nombre del equipo aparecerá un listado de todos
    los usuarios que lo componen.
    * Un usuario podrá pertenecer a más de un equipo.
</pre></div>
</td></tr></table>

<p>Vamos a utilizar la técnica de TDD para construir la funcionalidad
<strong>de abajo a arriba</strong>. Comenzaremos con tests que construyan la capa
de modelo (clases de entidad y repository) y después pasaremos a tests
que construyan la capa de servicio.</p>
<p>Por último, una vez implementados los métodos de servicios necesarios,
deberás implementar (lo haremos sin tests) las vistas y
controllers. Las vistas y controllers los probaremos de forma manual,
sin tests automáticos.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Los controllers no deben implementar ningún código adicional, sólo
llamar al método de servicio necesario. De esta forma nos
aseguramos que todo el código importante para la funcionalidad está
testeado y ha sido creado mediante TDD.</p>
</div>
<p>Recuerda que los pasos seguir la técnica de TDD:</p>
<ul>
<li><strong>Test</strong>: Primero debes escribir el test.</li>
<li><strong>Code</strong>: Después debes escribir el código que hace pasar el test (<strong>únicamente el código
necesario, no puedes escribir código de más</strong>)</li>
<li><strong>Refactor</strong>: Y, si es necesario, realizar una refactorización del código (los
  tests deben seguir pasando después de la refactorización).</li>
</ul>
<p>Deberás hacer <strong>un commit por cada fase Test-Code</strong>. Si haces
refactorización deberás hacerlo en otro commit adicional.</p>
<h3 id="pasos-a-seguir_4">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_4" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Crea la historia de usuario <code>008 Listado de equipos</code> en el tablero Trello.</p>
</li>
<li>
<p>Crea los <em>issues</em> correspondientes a esta historia:</p>
<ul>
<li>Servicio y modelo listado de equipos.</li>
<li>Vista y controller listado de equipos.</li>
</ul>
</li>
<li>
<p>Crea una rama para desarrollar el primer <em>issue</em> (llámala
  <code>servicio-equipos</code>, por ejemplo) y pásalo en el
  tablero a <code>In progress</code>.</p>
</li>
</ul>
<p>Este primer <em>issue</em> lo haremos de forma guiada usando TDD con los
tests que enumeraremos a continuación. El otro <em>issue</em> lo deberás
implementar por ti mismo. </p>
<h4>Primer test - Entidad <code>Equipo</code></h4>
<p>El primer test es para crear la entidad <code>Equipo</code>. Por ahora sólo
creamos la clase Java, sin las anotaciones JPA. Un equipo</p>
<p><strong>Fichero `src/test/java/madstodolist/EquipoTest.java</strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">madstodolist</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">madstodolist.model.Equipo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">crearEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></p>
<p>Escribe el código necesario para que pase el test. <strong>No debes escribir
código de más, sólo el código mínimo para que el test pase</strong>. Haz un
<em>commit</em> que contenga el test y el código y súbelo a la rama remota.</p>
<h4>Segundo test - Entidad en base de datos</h4>
<p>Con el segundo test queremos conseguir que funcione JPA con la entidad
<code>Equipo</code> y que podamos usar una tabla de equipos en la base de datos,
en la que podamos guardar entidades <code>equipo</code>.</p>
<p>Para comprobar que la entidad se ha guardado correctamente,
comprobaremos se ha actualizando su identificador. Lo hacemos
añadiendo el siguiente test:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">grabarEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>

        <span class="c1">// WHEN</span>
        <span class="n">equipoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">isNotNull</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Escribe el código necesario para se pase el test y haz un commit.</p>
<h4>Tercer test - Definición de igualdad entre equipos</h4>
<p>Ahora que hemos introducido el <code>id</code> del equipo escribimos un test
para comprobar que dos equipos son iguales. Debes escribir el código
de los métodos <code>equals</code> y <code>hashCode</code> (necesario este último para que
funcione correctamente la comprobación de igualdades en las
colecciones).</p>
<p>Hacemos los tests para que el <code>equals</code> funcione de la siguiente forma:</p>
<blockquote>
<p>Si alguno de los dos equipos no tiene <code>id</code> (es <code>null</code>), entonces se
deben comparar sus nombres. Ahora bien, si los dos equipos tienen
<code>id</code>, entonces se deben comparar esos <code>id</code>".</p>
</blockquote>
<p>Puedes guiarte por la implementación de <code>equals</code> y <code>hashCode</code> en
<code>Usuario</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarIgualdadEquipos</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Creamos tres equipos sin id, sólo con el nombre</span>
        <span class="n">Equipo</span> <span class="n">equipo1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Níquel&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Níquel&quot;</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Comprobamos igualdad basada en el atributo nombre</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo1</span><span class="o">).</span><span class="na">isNotEqualTo</span><span class="o">(</span><span class="n">equipo2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo2</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">equipo3</span><span class="o">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Añadimos identificadores y comprobamos igualdad por identificadores</span>
        <span class="n">equipo1</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">equipo2</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">equipo3</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2L</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Comprobamos igualdad basada en el atributo nombre</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo1</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">equipo2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo2</span><span class="o">).</span><span class="na">isNotEqualTo</span><span class="o">(</span><span class="n">equipo3</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Escribe el código necesario para se pase el test y haz un commit.</p>
<h4>Cuarto test - Buscar equipo en base de datos</h4>
<p>Escribimos ahora un test para recuperar equipos por su identificador
de la base de datos. Añadimos un equipo a la tabla en el fichero
<code>datos-test.sql</code> para poder comprobar que funciona correctamente.</p>
<p>Añadimos en el fichero <strong><code>src/test/java/resources/datos-test.sql</code></strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>INSERT INTO equipos (id, nombre) VALUES(&#39;1&#39;, &#39;Proyecto Cobalto&#39;);
</pre></div>
</td></tr></table></p>
<p>Test:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRecuperarEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>

        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Comprueba el test y si es necesario escribe el código estríctamente
necesario para que pase.</p>
<p>Haz un commit en la rama y súbelo a GitHub.</p>
<h4>Quinto test - Relación en memoria muchos-a-muchos entre equipos y usuarios</h4>
<p>Vamos ahora a diseñar un test que introduzca la relación entre equipos
y usuarios. Debe ser una relación muchos-a-muchos: un equipo contiene
muchos usuarios y un usuario puede pertenecer a 0, 1 o muchos equipos.</p>
<p>Empezamos por un test para crear la relación en memoria, con las
anotaciones mínimas para que JPA no se queje:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">relaciónMuchosAMuchosVacia</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>

        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Usuario</span><span class="o">(</span><span class="s">&quot;prueba@gmail.com&quot;</span><span class="o">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// THEN</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">()).</span><span class="na">isEmpty</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Para que este test funcione hay que crear la relación muchos-a-muchos
entre equipos y usuarios. Por sólo la definimos en memoria, sin
especificar cómo se mapea en la base de datos:</p>
<p><strong>Fichero <code>src/main/java/madstodolist/model/Equipo.java</code></strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    private String nombre;
<span class="gi">+    @ManyToMany</span>
<span class="gi">+    Set&lt;Usuario&gt; usuarios = new HashSet&lt;&gt;();</span>

...

    public void setId(Long id) {
        this.id = id;
    }

<span class="gi">+    public Set&lt;Usuario&gt; getUsuarios() {</span>
<span class="gi">+        return usuarios;</span>
<span class="gi">+    }</span>
</pre></div>
</td></tr></table></p>
<p><strong>Fichero <code>src/main/java/madstodolist/model/Usuario.java</code></strong>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    @OneToMany(mappedBy = &quot;usuario&quot;, fetch = FetchType.EAGER)
    Set&lt;Tarea&gt; tareas = new HashSet&lt;&gt;();

<span class="gi">+    @ManyToMany</span>
<span class="gi">+    Set&lt;Equipo&gt; equipos = new HashSet&lt;&gt;();</span>

...

<span class="gi">+    public Set&lt;Equipo&gt; getEquipos() {</span>
<span class="gi">+        return equipos;</span>
<span class="gi">+    }</span>
</pre></div>
</td></tr></table></p>
<p>Comprueba el test, haz un commit en la rama y súbelo a GitHub.</p>
<h4>Sexto test - Relación entre usuarios y equipos en base de datos</h4>
<p>En este test se va a especificar la relación muchos-a-muchos en base
de datos. Para definir la relación se va a definir la tabla
<code>equipo_usuario</code> en la que cada fila va a representar una relación de
un usuario con un equipo. Las columnas definen las claves ajenas que
contienen el identificador de equipo y el del usuario.</p>
<p>Para definir el test, creamos una relación en la base de datos de prueba:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>INSERT INTO tareas (id, titulo, usuario_id) VALUES(&#39;2&#39;, &#39;Renovar DNI&#39;, &#39;1&#39;);
<span class="gi">+ INSERT INTO equipos (id, nombre) VALUES(&#39;1&#39;, &#39;Proyecto Cobalto&#39;);</span>
<span class="gi">+ INSERT INTO equipo_usuario (fk_equipo, fk_usuario) VALUES(&#39;1&#39;, &#39;1&#39;);</span>
</pre></div>
</td></tr></table>

<p>Y comprobamos que se el usuario y equipo devuelto por cada clase
<em>repository</em> tienen actualizada esa relación:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UsuarioRepository</span> <span class="n">usuarioRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRelacionBaseDatos</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="c1">// THEN</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Para solucionar el test actualizamos la definición de la relación en
las entidades:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    @ManyToMany
<span class="gi">+    @JoinTable(name = &quot;equipo_usuario&quot;,</span>
<span class="gi">+            joinColumns = { @JoinColumn(name = &quot;fk_equipo&quot;) },</span>
<span class="gi">+            inverseJoinColumns = {@JoinColumn(name = &quot;fk_usuario&quot;)})</span>
    Set&lt;Usuario&gt; usuarios = new HashSet&lt;&gt;();
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="gd">-    @ManyToMany</span>
<span class="gi">+    @ManyToMany(mappedBy = &quot;usuarios&quot;)</span>
    Set&lt;Equipo&gt; equipos = new HashSet&lt;&gt;();
</pre></div>
</td></tr></table>

<p>Comprueba el test, haz un commit en la rama y súbelo a GitHub.</p>
<h4>Séptimo test - listado de equipos</h4>
<p>Ya por fin tenemos todo lo necesario para definir un test para obtener
una lista de equipos en el <em>repository</em>:</p>
<p>Actualizamos la base de datos de prueba con otro equipo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>INSERT INTO equipo_usuario (fk_equipo, fk_usuario) VALUES(&#39;1&#39;, &#39;1&#39;);
<span class="gi">+ INSERT INTO equipos (id, nombre) VALUES(&#39;2&#39;, &#39;Proyecto Adamantium&#39;);</span>
</pre></div>
</td></tr></table>

<p>Y añadimos el test. Queremos que el tipo devuelto por el <em>repository</em>
sea <em>List</em>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarFindAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>La solución consiste en añadir el método <code>findAll</code> en la interfaz
p<code>EquipoRepository</code>, definiendo el tipo
devuelto como <em>List</em>. Spring Boot se encarga de construir
automáticamente la implementación de este método.</p>
<p><strong>Fichero <code>EquipoRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="gi">+ import java.util.List;</span>

public interface EquipoRepository extends CrudRepository&lt;Equipo, Long&gt; {
<span class="gi">+     public List&lt;Equipo&gt; findAll();</span>
}
</pre></div>
</td></tr></table>

<h4>Octavo test - Método de servicio para el listado de equipos</h4>
<p>¡Y por fin llegamos a la capa de servicio!</p>
<p>Creamos el test que nos obliga a codificar en esa capa el método que
lista todos los equipos existentes. Lo llamamos
<code>findAllOrderedByName()</code> para indicar que queremos que el resultado
sea una lista ordenada por los nombres de los equipos.</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">madstodolist</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">madstodolist.model.Equipo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">madstodolist.service.EquipoService</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

 <span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

 <span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
 <span class="nd">@SpringBootTest</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoServiceTest</span> <span class="o">{</span>

     <span class="nd">@Autowired</span>
     <span class="n">EquipoService</span> <span class="n">equipoService</span><span class="o">;</span>

     <span class="nd">@Test</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtenerListadoEquipos</span><span class="o">()</span> <span class="o">{</span>
         <span class="c1">// GIVEN</span>
         <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

         <span class="c1">// WHEN</span>
         <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">findAllOrderedByName</span><span class="o">();</span>

         <span class="c1">// THEN</span>
         <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
         <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Adamantium&quot;</span><span class="o">);</span>
         <span class="n">assertThat</span><span class="o">(</span><span class="n">equipos</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Escribe el código estríctamente necesario para que pase. Haz un commit
en la rama y súbelo a GitHub.</p>
<h4>Noveno test - Método de servicio para recuperar un equipo</h4>
<p>Vamos a centrar este test en la forma de traer a memoria los objetos
que participan en la relación <code>USUARIO-EQUIPO</code>. </p>
<p>En JPA hay dos formas de definir una relación a-muchos:</p>
<ul>
<li>
<p><code>EAGER</code>: Si una relación a-muchos es <code>EAGER</code>, cuando la clase
  repository devuelve un objeto (ya sea al recuperarlo
  individualmente, o en una consulta en la que se recupera una
  colección), se obtienen también de la base de datos todos los
  objetos con los que está relacionado. Por ejemplo, en la práctica
  tenemos definida de esta forma la relación entre usuarios y tareas.</p>
</li>
<li>
<p><code>LAZY</code>: Si una relación a-muchos es <code>LAZY</code>, cuando la clase
  repository devuelve un objeto, no recupera de la base de datos los
  objetos relacionados. Sólo lo hace cuando se accede a la colección
  que contiene la relación. Entonces es cuando se realiza la consulta
  a la base de datos y se traen estos objetos a memoria. Si estos
  objetos tienen otras relaciones se traerán a memoria o no
  dependiendo de si son <code>EAGER</code> o <code>LAZY</code>.</p>
</li>
</ul>
<p>Para que funcione la recuperación perezosa debe estar abierta la
  conexión con la base de datos en el momento en que se accede a la
  colección. Para ello es muy importante la etiqueta
  <code>@Transactional</code>. Cuando ponemos esta etiqueta en los métodos de las
  clases de servicio se garantiza que todo el método se realiza en una
  única transacción. Por ello, al finalizar el método se cerrará la
  conexión con la base de datos y el objeto que se devolverá al
  <em>controller</em> <strong>estará desconectado de la base de datos</strong>, por lo que
  la recuperación perezosa no funcionará en el <em>controller</em>.</p>
<p>En el caso de la relación USUARIO-EQUIPO vamos a definir el siguiente
diseño:</p>
<ul>
<li>
<p>La relación entre un usuario y sus equipos será <code>EAGER</code>. Cuando
  recuperemos un usuario, recuperaremos también la información de
  todos los equipos en los que participa.</p>
</li>
<li>
<p>La relación entre un equipo y sus usuarios será <code>LAZY</code>. Esto es muy
  importante. Si no lo hiciéramos así ¡podríamos fácilmente traernos a
  memoria toda la base de datos!. Un equipo recuperaría todos sus
  usuarios, que también pueden estar en otros equipos, que a su vez
  también se traerían a memoria. </p>
</li>
</ul>
<p>Vamos entonces a definir un test que sirve para crear el método de
servicio que recupera un equipo y que se asegura de que la relación
entre equipos y usuarios es <code>LAZY</code>.</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtenerEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
        <span class="c1">// Comprobamos que la relación con Usuarios es lazy: al</span>
        <span class="c1">// intentar acceder a la colección de usuarios se debe lanzar una</span>
        <span class="c1">// excepción de tipo LazyInitializationException.</span>
        <span class="n">assertThatThrownBy</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}).</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">LazyInitializationException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Comprueba si hay que modificar el código, haz un commit y súbelo a
GitHub.</p>
<h4>Décimo test - comprobación de recuperación <em>eager</em> de equipos</h4>
<p>Hacemos ahora un test para que un usuario recupere de forma <em>eager</em>
sus equipos:</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRelacionUsuarioEquipos</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>

        <span class="c1">// THEN</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Comprueba que el test falla (por un error "failed to lazily initialize
a collection"), arregla el código para que pase, haz un commit y
súbelo a GitHub.</p>
<h4>Onceavo test - Método de servicio para obtener los usuarios de un equipo</h4>
<p>El último test que sirve para definir el método de servicio
<code>usuariosEquipo(Long idEquipo)</code> que devuelve la lista de usuarios de
un equipo.</p>
<p>Después de comprobar que la lista que se devuelve es correcta,
volvemos a comprobar que la relación entre usuarios y equipos es
<code>EAGER</code>, esto es, que desde un usuario se puede obtener la lista de
equipos a los que pertenece.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">obtenerUsuariosEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// En el application.properties se cargan los datos de prueba del fichero datos-test.sql</span>

        <span class="c1">// WHEN</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">usuariosEquipo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getEmail</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="o">);</span>
        <span class="c1">// Comprobamos que la relación entre usuarios y equipos es eager</span>
        <span class="c1">// Primero comprobamos que la colección de equipos tiene 1 elemento</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getEquipos</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">// Y después que el elemento es el equipo Proyecto Cobalto</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">usuarios</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">findFirst</span><span class="o">().</span><span class="na">get</span><span class="o">().</span><span class="na">getNombre</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Proyecto Cobalto&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Escribe el código necesario para que pase. Haz un commit en la rama y
súbelo a GitHub.</p>
<h4>Cierre del <em>issue</em></h4>
<p>Cuando hayas terminado todos los ciclos de TDD anteriores habrás
terminado el <em>issue</em> y testeado e implementado los métodos necesarios
para la clase de servicio que gestiona el listado de equipos y
usuarios de esos equipos.</p>
<ul>
<li>Crea un pull request que cierre el <em>issue</em>, comprueba que Travis pasa
correctamente los tests e intégralo en <code>master</code> en GitHub. Baja los
cambios al repositorio local.</li>
</ul>
<h4>Vista y controller listado de equipos</h4>
<ul>
<li>
<p>Abre un nuevo <em>issue</em> para implementar el controller y la vista que
permita listar los equipos y sus miembros.</p>
</li>
<li>
<p>Realiza el desarrollo del <em>issue</em> usando varios commits en los que
  añadas las funcionalidades poco a poco. No hace falta que hagas TDD,
  pero añade al menos un test por cada método del controller.</p>
</li>
</ul>
<h3 id="resto-de-historias-de-usuario">Resto de historias de usuario<a class="headerlink" href="#resto-de-historias-de-usuario" title="Permanent link">&para;</a></h3>
<p>Debes implementar la historia de usuario de la misma forma que hemos
implementado la anterior.</p>
<ul>
<li>
<p><strong>009 Gestionar pertenencia al equipo</strong>: Como usuario podré crear
nuevos equipos y añadirme y eliminarme de cualquiera de ellos para poder
participar y dejar de participar en ellos.</p>
</li>
<li>
<p><strong>010 Gestión de equipos (opcional)</strong>: Como administrador cambiar el
nombre y eliminar los equipos para adaptarlos a los proyectos y
estructura de la empresa.</p>
</li>
</ul>
<h3 id="pasos-a-seguir_5">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_5" title="Permanent link">&para;</a></h3>
<ul>
<li>Implementa cada historia de usuario usando el mismo proceso que
  hemos utilizado para la historia 008. Deberás pensar qué servicios
  son necesarios para la historia y cómo implementarlos haciendo TDD.</li>
</ul>
<p>Para cada historia haz dos <em>issues</em>: uno con TDD para implementar la
  capa de servicio y repository y otro sin TDD para la capa de
  controller y vista.</p>
<p>Cuando estés haciendo TDD completa el código para pasar los tests,
  uno a uno, <strong>haciendo un commit después de cada fase test-code</strong> y
  otro commit en la fase <strong>refactor</strong> (en el caso en que tengas que
  hacer refactorización). </p>
<p>Los incrementos de código introducidos por los tests deben ser
  pequeños. Debe haber <strong>entre 15 y 25 líneas de código</strong> añadidas en
  las fases de codificación (sin contar el código de los tests). No
  tomes este número de forma demasiado estricta; si en algún ciclo hay
  que añadir 35 líneas no pasa nada. Tampoco si haces menos
  de 15. Pero estaría mal tener que añadir 70 líneas para resolver un
  test.</p>
<ul>
<li>Cuando termines las historias de usuario (ve moviéndolas también en
  el tablero de Trello) haz el release 1.2.0 con la entrega final de
  la práctica.</li>
</ul>
<h2 id="entrega-y-evaluacion">Entrega y evaluación<a class="headerlink" href="#entrega-y-evaluacion" title="Permanent link">&para;</a></h2>
<ul>
<li>La práctica tiene una duración de 2 semanas y debe estar terminada
  el martes 29 de octubre.</li>
<li>La parte obligatoria puntúa sobre 8 y la opcional sobre 2 puntos.</li>
<li>La calificación de la práctica tiene un peso de un 7% en la nota
  final de la asignatura. </li>
<li>Para realizar la entrega se debe subir a Moodle un ZIP que contenga
  todo el proyecto, incluyendo el directorio <code>.git</code> que contiene la
  historia Git. Para ello comprime tu directorio local del proyecto
  <strong>después de haber hecho un <code>mvn clean</code></strong> para eliminar el
  directorio <code>target</code> que contiene los binarios compilados. Debes
  dejar también en Moodle la URL del repositorio en GitHub.</li>
</ul>
<p>Para la evaluación se tendrá en cuenta:</p>
<ul>
<li>Desarrollo continuo (los <em>commits</em> deben realizarse a lo largo de
  las 2 semanas y no dejar todo para la última semana).</li>
<li>Correcto desarrollo de la metodología.</li>
<li>Diseño e implementación del código y de los tests de las
  características desarrolladas.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../01-intro-spring-boot/practica1.html" title="Práctica 1" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Anterior
                </span>
                Práctica 1
              </span>
            </div>
          </a>
        
        
          <a href="../03-gitflow-despliegue/gitflow-despliegue.html" title="Práctica 3" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Siguiente
                </span>
                Práctica 3
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>